<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>TGI Kubernetes 003: Istio | 人生は短くて使える時間も限られてる。</title>



<link href="https://ziwon.github.io/index.xml" rel="alternate" type="application/rss+xml" title="人生は短くて使える時間も限られてる。" />

<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='https://ziwon.github.io/css/custom.css'><link rel='stylesheet' href='https://ziwon.github.io/css/syntax-atom-one-dark.css'><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">


<link rel=“stylesheet” type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/hybrid.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/go.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/rust.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/scala.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://ziwon.github.io/">
          <h1 class="title is-4">人生は短くて使える時間も限られてる。</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="twitter" href='https://twitter.com/theluno'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="github" href='https://github.com/ziwon'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:yngpil.yoon@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="instagram" href='https://instagram.com/ziwon.y'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
    <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <article>
      <h1 class="title"><a href="https://ziwon.github.io/post/tgik-003/">TGI Kubernetes 003: Istio</a></h1>
      <h2 class="subtitle is-6">2019-01-27 </h2>
      <div class="subtitle tags is-6 is-pulled-right">
        
        
<a class="subtitle is-6" href="/tags/kubernetes">#Kubernetes</a>



  
  | <a class="subtitle is-6" href="/tags/istio">#Istio</a>
  
  | <a class="subtitle is-6" href="/tags/service-mesh">#Service Mesh</a>
  
  | <a class="subtitle is-6" href="/tags/service-network">#Service Network</a>
  

        
      </div>
      <div class="content">
        

<h1 id="tgik-003-istio">TGIK 003: Istio</h1>

<p><a href="https://github.com/heptio/tgik/tree/master/episodes/003" target="_blank">세번째 에피소드</a>는 Istio에 다루고 있다. Istio를 돌려본 적은 없기 때문에 같이 배울 것이라고 한다.</p>

<p><center>•••</center></p>

<h1 id="service-network">Service Network</h1>

<p>앞서 자신이 발표한 자료를 참고하여, 서비스 네트워크에 대해 간략히 언급한다. 해당 슬라이드는 <a href="http://slides.eightypercent.net/linuxcon-ops-dividend/index.html" target="_blank">The Operations Dividend - Joe Beda (LinuxCon North America 2016)</a>를 참고한다.</p>

<p>여러 가지 타입의 마이크로 서비스가 있을 수 있다.</p>

<ul>
<li><strong>Implementation Detail</strong> (어플리케이션의 세부 구현, 모놀리틱 서비스가 나뉘어 각각의 모듈로 세부 구현된 서비스 )</li>
<li><strong>Shared Artificat, Priavete Instance</strong> (MySQL 데이터베이스처럼 개인 인스턴스를 하나씩 가지고 개발)</li>
<li><strong>Shared Instance</strong> (큰 조직의 공유 인스턴스, 다른 곳의 여러 팀과 팀이 사용하는 단일 서비스)</li>
<li><strong>Big-S Servie</strong> (회사 외부로 확장된 완전히 구현된 Saas 모델, 예. SendGrid)</li>
</ul>

<p>이러한 것들을 서비스 네트워크라고 부를 수 있고, <strong>Istio</strong>가 등장한 배경이라고 볼 수 있다. 서비스 네트워크 또는 서비스 메쉬에서는 서비스 과부하 발생 시에 다른 서비스나 네트워크로 처리하는 것도 중요하지만, 사용자를 가장한 공격자나 침입 탐지 등의 누가 이 서비스를 호출했는지에 대한 보안이나 신원확인도 중요하다고 한다.</p>

<h1 id="demo">Demo</h1>

<p>데모 영상은 Istio 설치와 배포 과정 중에 발생한 서비스 계정과 관련된 오류의 원인을 파악하고 수정하는데 많은 시간을 할애하고 있고, 또한 2017년도의 지난 내용이라 아래와 같이, Istio 공식 문서를 참고하며 따로 정리하였다. (그러나 크게 바뀌진 않고 세부 내용만 조금 다를 뿐이다.)</p>

<h2 id="istio-demo">Istio Demo</h2>

<p><code>QuickStart Heptio</code>를 사용해서 쿠버네티스 클러스터를 준비한다.</p>

<blockquote>
<p>개인적인 학습을 목적으로 기존 템플릿을 조금 수정하였다. 5대의 워커 노드(t2.small) 등 사소한 몇 가지를 변경하였다. (참고로, 원래 저장소의 CloudFormation 템플릿은 burstable EC2 인스턴스 타입을 지원하지 않는다.) - <a href="https://github.com/ziwon/quickstart-heptio" target="_blank">https://github.com/ziwon/quickstart-heptio</a></p>
</blockquote>

<p>최신 설치 방법 및 가이드는 다음 문서를 참조한다. (공식 문서가 워낙 잘되어 있어서 사실 따로 정리하는 게 큰 의미가 없어 보인다.)</p>

<ul>
<li><a href="https://istio.io/docs/setup/" target="_blank">https://istio.io/docs/setup/</a></li>
<li><a href="https://istio.io/docs/setup/kubernetes/quick-start/" target="_blank">https://istio.io/docs/setup/kubernetes/quick-start/</a></li>
</ul>

<p>Istio를 적당한 디렉토리에 다운 받는다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ mkdir -p ~/Workspace/TGIK/003
$ <span class="nb">cd</span> ~/Workspace/TGIK/003
$ curl -L https://git.io/getLatestIstio <span class="p">|</span> sh -</code></pre></div>
<p>다운 받은 후에는 Path를 잡아줘야 하는데, <code>kubectl</code>, <code>helm</code> 등과 마찬가지로 다음과 같이 그냥 <code>/usr/local/bin</code>에 복사한다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ cp ./bin/istioctl /usr/local/bin</code></pre></div>
<p>먼저, Istio의 CRD(Custom Resource Definition)을 생성한다.</p>

<p><details>
<summary>
    <code>shell
    kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml
</code>
</summary></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml
customresourcedefinition.apiextensions.k8s.io/virtualservices.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/destinationrules.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/serviceentries.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/gateways.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/envoyfilters.networking.istio.io created
customresourcedefinition.apiextensions.k8s.io/policies.authentication.istio.io created
customresourcedefinition.apiextensions.k8s.io/meshpolicies.authentication.istio.io created
customresourcedefinition.apiextensions.k8s.io/httpapispecbindings.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/httpapispecs.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/quotaspecbindings.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/quotaspecs.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/rules.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/attributemanifests.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/bypasses.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/circonuses.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/deniers.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/fluentds.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/kubernetesenvs.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/listcheckers.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/memquotas.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/noops.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/opas.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/prometheuses.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/rbacs.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/redisquotas.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/servicecontrols.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/signalfxs.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/solarwindses.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/stackdrivers.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/statsds.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/stdios.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/apikeys.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/authorizations.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/checknothings.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/kuberneteses.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/listentries.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/logentries.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/edges.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/metrics.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/quotas.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/reportnothings.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/servicecontrolreports.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/tracespans.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/rbacconfigs.rbac.istio.io created
customresourcedefinition.apiextensions.k8s.io/serviceroles.rbac.istio.io created
customresourcedefinition.apiextensions.k8s.io/servicerolebindings.rbac.istio.io created
customresourcedefinition.apiextensions.k8s.io/adapters.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/instances.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/templates.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/handlers.config.istio.io created</code></pre></div>
<p></details></p>

<p>다음으로, 데모 리소스를 설치한다. <code>install</code> 디렉토리에는 상호 TLS 인증용(<code>istio-demo-auth.yaml</code>)과 비인증용(<code>istio-demo.yaml</code>) 두 가지 파일이 있는데, <code>istio-demo-auth.yaml</code>를 사용한다.</p>

<blockquote>
<p>덧붙여서 학습용 목적의 개인 클러스터의 경우, 워커 노드의 리소스가 매우 작기 때문에, 기본 요구 사항에 맞는 노드를 찾지 못해 Pod의 스케쥴링 <code>Pending</code> 이 발생할 수 있다. 일단, 데모이니 생략하기로 한다. (또는 리밋을 걸어도 무방) <code>install/kubernetes/istio-demo.yaml</code> 파일의 13565 라인에서 13568 라인까지를 삭제한다.</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">          </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>PILOT_CACHE_SQUASH<span class="w">
</span><span class="w">            </span>value<span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w">
</span><span class="w">          </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>GODEBUG<span class="w">
</span><span class="w">            </span>value<span class="p">:</span><span class="w"> </span><span class="s2">&#34;gctrace=2&#34;</span><span class="w">
</span><span class="w">          </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>PILOT_PUSH_THROTTLE_COUNT<span class="w">
</span><span class="w">            </span>value<span class="p">:</span><span class="w"> </span><span class="s2">&#34;100&#34;</span><span class="w">
</span><span class="w">          </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>PILOT_TRACE_SAMPLING<span class="w">
</span><span class="w">            </span>value<span class="p">:</span><span class="w"> </span><span class="s2">&#34;100&#34;</span><span class="w">
</span><span class="w"></span><span class="m">13565</span><span class="w">     </span>resources<span class="p">:</span><span class="w">
</span><span class="w">            </span>requests<span class="p">:</span><span class="w">
</span><span class="w">              </span>cpu<span class="p">:</span><span class="w"> </span>500m<span class="w">
</span><span class="w"></span><span class="m">13568</span><span class="w">           </span>memory<span class="p">:</span><span class="w"> </span>2048Mi</code></pre></div>
<p>다음과 같이, Istio 컴포넌트를 설치한다.</p>

<p><details>
<summary>kubectl apply -f install/kubernetes/istio-demo-auth.yaml</summary></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl apply -f install/kubernetes/istio-demo-auth.yaml
namespace/istio-system created
configmap/istio-galley-configuration created
configmap/istio-grafana-custom-resources created
configmap/istio-grafana-configuration-dashboards created
configmap/istio-grafana created
configmap/istio-statsd-prom-bridge created
configmap/prometheus created
configmap/istio-security-custom-resources created
configmap/istio created
configmap/istio-sidecar-injector created
serviceaccount/istio-galley-service-account created
serviceaccount/istio-egressgateway-service-account created
serviceaccount/istio-ingressgateway-service-account created
serviceaccount/istio-grafana-post-install-account created
clusterrole.rbac.authorization.k8s.io/istio-grafana-post-install-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-grafana-post-install-role-binding-istio-system created
job.batch/istio-grafana-post-install created
serviceaccount/istio-mixer-service-account created
serviceaccount/istio-pilot-service-account created
serviceaccount/prometheus created
serviceaccount/istio-cleanup-secrets-service-account created
clusterrole.rbac.authorization.k8s.io/istio-cleanup-secrets-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-cleanup-secrets-istio-system created
job.batch/istio-cleanup-secrets created
serviceaccount/istio-security-post-install-account created
clusterrole.rbac.authorization.k8s.io/istio-security-post-install-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-security-post-install-role-binding-istio-system created
job.batch/istio-security-post-install created
serviceaccount/istio-citadel-service-account created
serviceaccount/istio-sidecar-injector-service-account created
customresourcedefinition.apiextensions.k8s.io/virtualservices.networking.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/destinationrules.networking.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/serviceentries.networking.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/gateways.networking.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/envoyfilters.networking.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/httpapispecbindings.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/httpapispecs.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/quotaspecbindings.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/quotaspecs.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/rules.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/attributemanifests.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/bypasses.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/circonuses.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/deniers.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/fluentds.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/kubernetesenvs.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/listcheckers.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/memquotas.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/noops.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/opas.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/prometheuses.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/rbacs.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/redisquotas.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/servicecontrols.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/signalfxs.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/solarwindses.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/stackdrivers.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/statsds.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/stdios.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/apikeys.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/authorizations.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/checknothings.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/kuberneteses.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/listentries.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/logentries.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/edges.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/metrics.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/quotas.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/reportnothings.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/servicecontrolreports.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/tracespans.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/rbacconfigs.rbac.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/serviceroles.rbac.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/servicerolebindings.rbac.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/adapters.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/instances.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/templates.config.istio.io unchanged
customresourcedefinition.apiextensions.k8s.io/handlers.config.istio.io unchanged
clusterrole.rbac.authorization.k8s.io/istio-galley-istio-system created
clusterrole.rbac.authorization.k8s.io/istio-egressgateway-istio-system created
clusterrole.rbac.authorization.k8s.io/istio-ingressgateway-istio-system created
clusterrole.rbac.authorization.k8s.io/istio-mixer-istio-system created
clusterrole.rbac.authorization.k8s.io/istio-pilot-istio-system created
clusterrole.rbac.authorization.k8s.io/prometheus-istio-system created
clusterrole.rbac.authorization.k8s.io/istio-citadel-istio-system created
clusterrole.rbac.authorization.k8s.io/istio-sidecar-injector-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-galley-admin-role-binding-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-egressgateway-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-ingressgateway-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-mixer-admin-role-binding-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-pilot-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/prometheus-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-citadel-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-sidecar-injector-admin-role-binding-istio-system created
service/istio-galley created
service/istio-egressgateway created
service/istio-ingressgateway created
service/grafana created
service/istio-policy created
service/istio-telemetry created
service/istio-pilot created
service/prometheus created
service/istio-citadel created
service/servicegraph created
service/istio-sidecar-injector created
deployment.extensions/istio-galley created
deployment.extensions/istio-egressgateway created
deployment.extensions/istio-ingressgateway created
deployment.extensions/grafana created
deployment.extensions/istio-policy created
deployment.extensions/istio-telemetry created
deployment.extensions/istio-pilot created
deployment.extensions/prometheus created
deployment.extensions/istio-citadel created
deployment.extensions/servicegraph created
deployment.extensions/istio-sidecar-injector created
deployment.extensions/istio-tracing created
gateway.networking.istio.io/istio-autogenerated-k8s-ingress created
horizontalpodautoscaler.autoscaling/istio-egressgateway created
horizontalpodautoscaler.autoscaling/istio-ingressgateway created
horizontalpodautoscaler.autoscaling/istio-policy created
horizontalpodautoscaler.autoscaling/istio-telemetry created
horizontalpodautoscaler.autoscaling/istio-pilot created
service/jaeger-query created
service/jaeger-collector created
service/jaeger-agent created
service/zipkin created
service/tracing created
mutatingwebhookconfiguration.admissionregistration.k8s.io/istio-sidecar-injector created
attributemanifest.config.istio.io/istioproxy created
attributemanifest.config.istio.io/kubernetes created
stdio.config.istio.io/handler created
logentry.config.istio.io/accesslog created
logentry.config.istio.io/tcpaccesslog created
rule.config.istio.io/stdio created
rule.config.istio.io/stdiotcp created
metric.config.istio.io/requestcount created
metric.config.istio.io/requestduration created
metric.config.istio.io/requestsize created
metric.config.istio.io/responsesize created
metric.config.istio.io/tcpbytesent created
metric.config.istio.io/tcpbytereceived created
prometheus.config.istio.io/handler created
rule.config.istio.io/promhttp created
rule.config.istio.io/promtcp created
kubernetesenv.config.istio.io/handler created
rule.config.istio.io/kubeattrgenrulerule created
rule.config.istio.io/tcpkubeattrgenrulerule created
kubernetes.config.istio.io/attributes created
destinationrule.networking.istio.io/istio-policy created
destinationrule.networking.istio.io/istio-telemetry created</code></pre></div>
<p></details></p>

<p>설치 후에는 서비스 목록을 확인한다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get svc -n istio-system
NAME                     TYPE           CLUSTER-IP       EXTERNAL-IP                                                                    PORT<span class="o">(</span>S<span class="o">)</span>                                                                                                                   AGE
grafana                  ClusterIP      <span class="m">10</span>.103.36.168    &lt;none&gt;                                                                         <span class="m">3000</span>/TCP                                                                                                                  1m
istio-citadel            ClusterIP      <span class="m">10</span>.105.126.133   &lt;none&gt;                                                                         <span class="m">8060</span>/TCP,9093/TCP                                                                                                         1m
istio-egressgateway      ClusterIP      <span class="m">10</span>.96.167.111    &lt;none&gt;                                                                         <span class="m">80</span>/TCP,443/TCP                                                                                                            1m
istio-galley             ClusterIP      <span class="m">10</span>.101.13.252    &lt;none&gt;                                                                         <span class="m">443</span>/TCP,9093/TCP                                                                                                          1m
istio-ingressgateway     LoadBalancer   <span class="m">10</span>.110.86.12     a9ea060f3215111e98ff402da3f66b58-1123416063.ap-northeast-2.elb.amazonaws.com   <span class="m">80</span>:31380/TCP,443:31390/TCP,31400:31400/TCP,15011:32529/TCP,8060:32743/TCP,853:32409/TCP,15030:32031/TCP,15031:30142/TCP   1m
istio-pilot              ClusterIP      <span class="m">10</span>.100.252.232   &lt;none&gt;                                                                         <span class="m">15010</span>/TCP,15011/TCP,8080/TCP,9093/TCP                                                                                     1m
istio-policy             ClusterIP      <span class="m">10</span>.105.64.250    &lt;none&gt;                                                                         <span class="m">9091</span>/TCP,15004/TCP,9093/TCP                                                                                               1m
istio-sidecar-injector   ClusterIP      <span class="m">10</span>.97.255.80     &lt;none&gt;                                                                         <span class="m">443</span>/TCP                                                                                                                   1m
istio-telemetry          ClusterIP      <span class="m">10</span>.100.243.108   &lt;none&gt;                                                                         <span class="m">9091</span>/TCP,15004/TCP,9093/TCP,42422/TCP                                                                                     1m
jaeger-agent             ClusterIP      None             &lt;none&gt;                                                                         <span class="m">5775</span>/UDP,6831/UDP,6832/UDP                                                                                                1m
jaeger-collector         ClusterIP      <span class="m">10</span>.96.82.132     &lt;none&gt;                                                                         <span class="m">14267</span>/TCP,14268/TCP                                                                                                       1m
jaeger-query             ClusterIP      <span class="m">10</span>.97.191.144    &lt;none&gt;                                                                         <span class="m">16686</span>/TCP                                                                                                                 1m
prometheus               ClusterIP      <span class="m">10</span>.104.183.23    &lt;none&gt;                                                                         <span class="m">9090</span>/TCP                                                                                                                  1m
servicegraph             ClusterIP      <span class="m">10</span>.102.175.176   &lt;none&gt;                                                                         <span class="m">8088</span>/TCP                                                                                                                  1m
tracing                  ClusterIP      <span class="m">10</span>.103.166.96    &lt;none&gt;                                                                         <span class="m">80</span>/TCP                                                                                                                    1m
zipkin                   ClusterIP      <span class="m">10</span>.108.3.146     &lt;none&gt;                                                                         <span class="m">9411</span>/TCP</code></pre></div>
<p>다음과 같이, Istio 설치가 완료되었다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get po -n istio-system
NAME                                     READY   STATUS      RESTARTS   AGE
grafana-7f6cd4bf56-lqgck                 <span class="m">1</span>/1     Running     <span class="m">0</span>          2m
istio-citadel-7dd558dcf-m2qjf            <span class="m">1</span>/1     Running     <span class="m">0</span>          2m
istio-cleanup-secrets-shkfz              <span class="m">0</span>/1     Completed   <span class="m">0</span>          2m
istio-egressgateway-8666f9bdcc-s5xpv     <span class="m">1</span>/1     Running     <span class="m">0</span>          2m
istio-galley-787758f7b8-lc97g            <span class="m">1</span>/1     Running     <span class="m">0</span>          2m
istio-grafana-post-install-2n6zv         <span class="m">0</span>/1     Completed   <span class="m">0</span>          2m
istio-ingressgateway-645bbdc9db-znhnx    <span class="m">1</span>/1     Running     <span class="m">0</span>          2m
istio-pilot-86b6679ddf-7k795             <span class="m">0</span>/2     Pending     <span class="m">0</span>          2m
istio-policy-6b59f7bdfd-9xgw6            <span class="m">2</span>/2     Running     <span class="m">0</span>          2m
istio-security-post-install-vpbh4        <span class="m">0</span>/1     Completed   <span class="m">0</span>          2m
istio-sidecar-injector-d7f98d9cb-ght2x   <span class="m">1</span>/1     Running     <span class="m">0</span>          2m
istio-telemetry-f94b484cd-wsd72          <span class="m">2</span>/2     Running     <span class="m">0</span>          2m
istio-tracing-7596597bd7-wh57j           <span class="m">1</span>/1     Running     <span class="m">0</span>          2m
prometheus-76db5fddd5-w5zrl              <span class="m">1</span>/1     Running     <span class="m">0</span>          2m
servicegraph-56dddff777-q66jx            <span class="m">1</span>/1     Running     <span class="m">0</span>          2m</code></pre></div>
<h2 id="envoy-컨테이너-주입">Envoy 컨테이너 주입</h2>

<p>Instio Sidecar Injector는 Envoy 컨테이너를 주입하는 역할을 하는데, 두 가지 방법이 있다.</p>

<p>특정 네임스페이스를 라벨링하여 자동으로 주입한다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl label namespace &lt;namespace&gt; istio-injection<span class="o">=</span>enabled
$ kubectl create -n &lt;namespace&gt; -f &lt;your-app-spec&gt;.yaml</code></pre></div>
<p>또는 다음과 같이 <code>istioctl</code>을 사용하여 수동으로 주입할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ istioctl kube-inject -f &lt;your-app-spec&gt;.yaml <span class="p">|</span> kubectl apply -f -</code></pre></div>
<p>이하, 아래 예제 서비스는 모두 <code>istioctl</code>을 사용해서 배포한다.</p>

<h3 id="helloworld-예제">HelloWorld 예제</h3>

<p>먼저, 다운 받아 놓은 Istio의 <code>sample</code> 폴더 밑에 있는 <code>hello-world</code> 서비스를 배포해보자.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl apply -f &lt;<span class="o">(</span>istioctl kube-inject -f helloworld.yaml<span class="o">)</span></code></pre></div>
<p>Istio 인그레스 컨트롤러에서 획득한 ELB 주소와 포트로 접속하면, 다음과 같이 Hello version 1과 Hello version 2로 로드밸런싱 되는 것을 볼 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ curl http://af4e1ca06216211e9bc6d02f1aa55be0-1809927191.ap-northeast-2.elb.amazonaws.com/hello
Hello version: v1, instance: helloworld-v1-67f4b97db-ldzhl

$ curl http://af4e1ca06216211e9bc6d02f1aa55be0-1809927191.ap-northeast-2.elb.amazonaws.com/hello
Hello version: v2, instance: helloworld-v2-c4bb7875c-rnpnd

$ curl http://af4e1ca06216211e9bc6d02f1aa55be0-1809927191.ap-northeast-2.elb.amazonaws.com/hello
Hello version: v1, instance: helloworld-v1-67f4b97db-ldzhl

$ curl http://af4e1ca06216211e9bc6d02f1aa55be0-1809927191.ap-northeast-2.elb.amazonaws.com/hello
Hello version: v2, instance: helloworld-v2-c4bb7875c-rnpnd</code></pre></div>
<h3 id="bookinfo-예제">BookInfo 예제</h3>

<p>BookInfo 예제의 배포도 HelloWorld와 동일하다.</p>

<p>자세한 것은 다음 문서를 참고한다.</p>

<ul>
<li><a href="https://istio.io/docs/examples/bookinfo/" target="_blank">https://istio.io/docs/examples/bookinfo/</a></li>
</ul>

<p>BookInfo 예제도 접속할 때마다, Istio 서비스 메쉬로 화면이 갱신되는 것을 확인할 수 있다.</p>

<p><img src="../../tgik-003/bookinfo.png" alt="" /></p>

<h2 id="모니터링">모니터링</h2>

<h3 id="service-graph">Service Graph</h3>

<p>서비스 그래프는 포트 포워딩 후에, <code>http://localhost:8088/dotviz</code>에 접속하게 되면 서비스 그래프를 확인할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl -n istio-system port-forward <span class="k">$(</span>kubectl -n istio-system get pod -l <span class="nv">app</span><span class="o">=</span>servicegraph -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].metadata.name}&#39;</span> <span class="m">8088</span>:8080 <span class="p">&amp;</span></code></pre></div>
<p><img src="../../tgik-003/service-graph.png" alt="" /></p>

<p>그 외에도 다양한 방법의 시각화를 제공하고 있다.</p>

<ul>
<li><p>/force/forcegraph.html (D3.js 시각화 그래프)</p></li>

<li><p>/dotviz (정적 시각화 그래프)</p></li>

<li><p>/dotgraph (DOT 직렬화 데이터)</p></li>

<li><p>/d3graph (D3 visualization JSON 직렬화 데이터)</p></li>

<li><p>/graph (JSON 직렬화 데이터)</p></li>
</ul>

<p>이상, 자세한 내용은 다음 링크를 참고한다.</p>

<ul>
<li><a href="https://istio.io/docs/tasks/telemetry/using-istio-dashboard/" target="_blank">https://istio.io/docs/tasks/telemetry/using-istio-dashboard/</a></li>
</ul>

<h3 id="graphana">Graphana</h3>

<p>또한 Istio 메쉬 대시보드, 서비스 대시보드, 워크 로드 대시보드 등을 비릇해 다양한 대시보드를 통해 메트릭을 확인할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl -n istio-system port-forward <span class="k">$(</span>kubectl -n istio-system get pod -l <span class="nv">app</span><span class="o">=</span>grafana -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].metadata.name}&#39;</span><span class="k">)</span> <span class="m">3000</span>:3000 <span class="p">&amp;</span></code></pre></div>
<p><img src="../../tgik-003/grafana.png" alt="" /></p>

<p>자세한 내용은 다음 링크를 참고한다.</p>

<ul>
<li><a href="https://istio.io/docs/tasks/telemetry/using-istio-dashboard/" target="_blank">https://istio.io/docs/tasks/telemetry/using-istio-dashboard/</a></li>
</ul>

<h3 id="jaeger">Jaeger</h3>

<p>예거라는 분산 로그 추적 시스템을 통해 마이크로 서비스의 API 하나하나를 추적할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl port-forward -n istio-system <span class="k">$(</span>kubectl get pod -n istio-system -l <span class="nv">app</span><span class="o">=</span>jaeger -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].metadata.name}&#39;</span><span class="k">)</span> <span class="m">16686</span>:16686 <span class="p">&amp;</span></code></pre></div>
<p><img src="../../tgik-003/jaeger-001.png" alt="" />
<img src="../../tgik-003/jaeger-002.png" alt="" />
<img src="../../tgik-003/jaeger-003.png" alt="" /></p>

<p>이상, 자세한 내용은 다음 링크를 참고한다.</p>

<ul>
<li><a href="https://istio.io/docs/tasks/telemetry/distributed-tracing/" target="_blank">https://istio.io/docs/tasks/telemetry/distributed-tracing/</a></li>
<li><a href="https://www.jaegertracing.io" target="_blank">https://www.jaegertracing.io</a></li>
</ul>

<p><center>•••</center></p>

<h2 id="service-account-오류-수정">Service Account 오류 수정</h2>

<p>2017년 데모 당시에는 Istio RBAC 활성화시에 제대로 배포되지 않는 버그가 있었다. 그 과정이 흥미진진하고 마지막에 해결하는 모습이 멋있어서 그 과정을 간략히 요약해보았다.</p>

<ul>
<li><p><a href="https://www.youtube.com/watch?v=WnDG-5cvEew&amp;feature=youtu.be&amp;t=2491" target="_blank">Ingress/Engress 에러 확인</a></p></li>

<li><p><a href="https://www.youtube.com/watch?v=WnDG-5cvEew&amp;feature=youtu.be&amp;t=2540" target="_blank">일단, Ingress/Engress 컨테이너 로그를 확인해 봄</a></p></li>

<li><p><a href="https://www.youtube.com/watch?v=WnDG-5cvEew&amp;feature=youtu.be&amp;t=2644" target="_blank">Pilot Pod에서 api-server 컨테이너 로그 확인</a></p></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">* failed to register Third-Party Resources. User <span class="s2">&#34;system:serviceaccount:default:istio-pilot-service-account&#34;</span> cannot get thirdpartyresources.exentions at the cluster scope. <span class="o">(</span>get thirdpartyresources.extensions istio-config.istio.io<span class="o">)</span>
* failed to register Thrid-Party REsources. Failed to create all TPRs</code></pre></div>
<ul>
<li><p><a href="https://www.youtube.com/watch?v=WnDG-5cvEew&amp;feature=youtu.be&amp;t=3230" target="_blank">Istio 네임스페이스가 디폴트가 아닌 경우에 ClusterRoleBinding을 변경해줘야 하는 이슈 PR(333)</a></p></li>

<li><p>Istio mixer가 뭔가 하는 게 있는데, RBAC 롤을 제대로 안 주고 있는 것 같다고 추측. 이에 누군가가 mixer가 pilot 애셋을 가지고 있는지 확인해보라고 함.</p></li>

<li><p><a href="https://www.youtube.com/watch?v=WnDG-5cvEew&amp;feature=youtu.be&amp;t=3230" target="_blank"><code>istio-pilot-service-account</code> 서비스 계정 추가</a></p></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl edit deployment istio-mixer
serviceAccount: istio-pilot-service-account</code></pre></div>
<ul>
<li>추후 RBAC이 활성화 되었을 때 k8s TPR이 생성되지 않는 동일한 <a href="https://github.com/istio/istio/issues/327" target="_blank">327번 이슈</a> 확인</li>
</ul>

<h2 id="기타-링크">기타 링크</h2>

<ul>
<li><a href="https://github.com/subicura/istio-demo" target="_blank">https://github.com/subicura/istio-demo</a></li>
<li><a href="https://www.katacoda.com/courses/istio/deploy-istio-on-kubernetes" target="_blank">https://www.katacoda.com/courses/istio/deploy-istio-on-kubernetes</a></li>
</ul>

        
        <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/post/tgik-002/">TGI Kubernetes 002: Networking and Services</a></li>
	
	<li><a href="/post/tgik-001/">TGI Kubernetes 001: A Quick Tour</a></li>
	
	<li><a href="/post/bastion-in-kops/">Kops에서 Bastion 호스트 SSH로 접속하기</a></li>
	
</ul>
</div>
        
      </div>
    </article>
    

    
    <nav class="post-nav">
        
        <a class="prev" href="/post/tgik-004/">
            &lt; <span class="prev-text nav-default">TGI Kubernetes 004: RBAC</span>
                <span class="prev-text nav-mobile"></span>
        </a>
        
        <a class="next" href="/post/tgik-002/">
            <span class="next-text nav-default">TGI Kubernetes 002: Networking and Services</span>
            <span class="next-text nav-mobile"></span>
            >
        </a>
    </nav>

  </div>
 
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'ziwon';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p><a href="https://github.com/ziwon">Youngpil Yoon</a></p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129419926-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

