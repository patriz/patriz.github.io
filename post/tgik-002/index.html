<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>TGI Kubernetes 002: Networking and Services | 人生は短くて使える時間も限られてる。</title>



<link href="https://ziwon.github.io/index.xml" rel="alternate" type="application/rss+xml" title="人生は短くて使える時間も限られてる。" />
<link rel='stylesheet' href='https://ziwon.github.io/css/style-kiss.css'><link rel='stylesheet' href='https://ziwon.github.io/css/custom.css'><link rel='stylesheet' href='https://ziwon.github.io/css/syntax-github.css'><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">



<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">


<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/bash.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/go.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/rust.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/scala.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://ziwon.github.io/">
          <h1 class="title is-4">人生は短くて使える時間も限られてる。</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="twitter" href='https://twitter.com/theluno'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="github" href='https://github.com/ziwon'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:yngpil.yoon@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="instagram" href='https://instagram.com/ziwon.y'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
    <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <article>
      <h1 class="title"><a href="https://ziwon.github.io/post/tgik-002/">TGI Kubernetes 002: Networking and Services</a></h1>
      <h2 class="subtitle is-6">2019-01-19 </h2>
      <div class="subtitle tags is-6 is-pulled-right">
        
        
<a class="subtitle is-6" href="/tags/kubernetes">#Kubernetes</a>



  
  | <a class="subtitle is-6" href="/tags/heptio">#Heptio</a>
  
  | <a class="subtitle is-6" href="/tags/cloudformation">#CloudFormation</a>
  

        
      </div>
      <div class="content">
        

<h1 id="tgik-thanks-god-it-s-kubernetes">TGIK: Thanks God It&rsquo;s Kubernetes</h1>

<p><a href="https://github.com/heptio/tgik/tree/master/episodes/002" target="_blank">두 번째 에피소드</a>는 네트워킹과 서비스에 관해 다룬다. 관련 링크나 노트는 없다.</p>

<blockquote>
<p>결국, heptio-quickstart를 AWS에 올리고 따라해보았다. 아무래도 GCP UI나 커맨드라인 결과가 조금 다른 것으로 인해 혼란의 여지가 있을 것 같다. QuickStart이긴 하나, CloudFormation 기반으로 Kubernetes 컴포넌트들을 설치해가는 스크립트를 하나하나씩 살펴보는 것도 유의미해보인다.</p>
</blockquote>

<p><center>•••</center></p>

<h1 id="networking">Networking</h1>

<p>먼저, 10개의 <code>kuard</code> <code>Pod</code>를 띄운다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl run --replicas<span class="o">=</span><span class="m">10</span> --image<span class="o">=</span>gcr.io/kuar-demo/kuard-amd64:1 kuard
deployment.apps <span class="s2">&#34;kuard&#34;</span> created

$ kubectl get pods
NAME                    READY     STATUS    RESTARTS   AGE
kuard-dbdd7955d-4kdbr   <span class="m">1</span>/1       Running   <span class="m">0</span>          13s
kuard-dbdd7955d-5r757   <span class="m">1</span>/1       Running   <span class="m">0</span>          13s
kuard-dbdd7955d-dhts5   <span class="m">1</span>/1       Running   <span class="m">0</span>          13s
kuard-dbdd7955d-hsl87   <span class="m">1</span>/1       Running   <span class="m">0</span>          13s
kuard-dbdd7955d-k8x7l   <span class="m">1</span>/1       Running   <span class="m">0</span>          13s
kuard-dbdd7955d-ms8hb   <span class="m">1</span>/1       Running   <span class="m">0</span>          13s
kuard-dbdd7955d-qfjbk   <span class="m">1</span>/1       Running   <span class="m">0</span>          13s
kuard-dbdd7955d-tfgdl   <span class="m">1</span>/1       Running   <span class="m">0</span>          13s
kuard-dbdd7955d-v8lj2   <span class="m">1</span>/1       Running   <span class="m">0</span>          13s
kuard-dbdd7955d-wzcf4   <span class="m">1</span>/1       Running   <span class="m">0</span>          13s</code></pre></div>
<p><code>port-forward</code>으로 실행 중인 <code>kuard</code>에 접속해본다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl port-forward kuard-dbdd7955d-4kdbr <span class="m">8080</span>:8080</code></pre></div>
<p>그리고 해당 <code>Pod</code>의 쉘에 접속해서 호스트 이름과 IP 주소를 확인한다. 호스트 네임은 <code>kuard-dbdd7955d-4kdbr</code>이고, IP 주소는 <code>192.168.3.140</code>으로 확인된다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl <span class="nb">exec</span> -it kuard-dbdd7955d-4kdbr ash
~ $ hostname
kuard-dbdd7955d-4kdbr
~ $ ifconfig
eth0      Link encap:Ethernet  HWaddr 4E:C8:47:58:DF:76  
          inet addr:192.168.3.140  Bcast:0.0.0.0  Mask:255.255.255.255
          inet6 addr: fe80::4cc8:47ff:fe58:df76/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:8 errors:0 dropped:0 overruns:0 frame:0
          TX packets:8 errors:0 dropped:1 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:648 <span class="o">(</span><span class="m">648</span>.0 B<span class="o">)</span>  TX bytes:648 <span class="o">(</span><span class="m">648</span>.0 B<span class="o">)</span>

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1 
          RX bytes:0 <span class="o">(</span><span class="m">0</span>.0 B<span class="o">)</span>  TX bytes:0 <span class="o">(</span><span class="m">0</span>.0 B<span class="o">)</span></code></pre></div>
<p>또는 다음과 같이 <code>-o wide</code> 옵션으로 <code>Node</code>와 <code>Pod</code>의 IP 주소를 같이 확인할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get pods -o wide
NAME                    READY     STATUS    RESTARTS   AGE       IP              NODE
kuard-dbdd7955d-4kdbr   <span class="m">1</span>/1       Running   <span class="m">0</span>          2m        <span class="m">192</span>.168.3.140   ip-10-0-8-254.ap-northeast-2.compute.internal
kuard-dbdd7955d-5r757   <span class="m">1</span>/1       Running   <span class="m">0</span>          2m        <span class="m">192</span>.168.49.6    ip-10-0-8-176.ap-northeast-2.compute.internal
kuard-dbdd7955d-dhts5   <span class="m">1</span>/1       Running   <span class="m">0</span>          2m        <span class="m">192</span>.168.49.9    ip-10-0-8-176.ap-northeast-2.compute.internal
kuard-dbdd7955d-hsl87   <span class="m">1</span>/1       Running   <span class="m">0</span>          2m        <span class="m">192</span>.168.49.10   ip-10-0-8-176.ap-northeast-2.compute.internal
kuard-dbdd7955d-k8x7l   <span class="m">1</span>/1       Running   <span class="m">0</span>          2m        <span class="m">192</span>.168.49.8    ip-10-0-8-176.ap-northeast-2.compute.internal
kuard-dbdd7955d-ms8hb   <span class="m">1</span>/1       Running   <span class="m">0</span>          2m        <span class="m">192</span>.168.3.137   ip-10-0-8-254.ap-northeast-2.compute.internal
kuard-dbdd7955d-qfjbk   <span class="m">1</span>/1       Running   <span class="m">0</span>          2m        <span class="m">192</span>.168.3.138   ip-10-0-8-254.ap-northeast-2.compute.internal
kuard-dbdd7955d-tfgdl   <span class="m">1</span>/1       Running   <span class="m">0</span>          2m        <span class="m">192</span>.168.3.136   ip-10-0-8-254.ap-northeast-2.compute.internal
kuard-dbdd7955d-v8lj2   <span class="m">1</span>/1       Running   <span class="m">0</span>          2m        <span class="m">192</span>.168.3.139   ip-10-0-8-254.ap-northeast-2.compute.internal
kuard-dbdd7955d-wzcf4   <span class="m">1</span>/1       Running   <span class="m">0</span>          2m        <span class="m">192</span>.168.49.7    ip-10-0-8-176.ap-northeast-2.compute.internal</code></pre></div>
<p>보다시피, Kubernetes에서 Pod은 자신의 고유 IP를 가지고 있고, Pod의 IP가 Node의 IP와는 다르다는 것에 주목한다. 이는 Kubernetes의 전신인 구글의 Borg 또는 Borg에서 영감을 받은 Mesos, 또는 단순히 여러 도커가 실행되는 기타 노드 클러스터와는 다른 점이라고 한다. Borg에서는 많은 워크로드들이 IP를 공유했었다고 한다. 이는 여러가지 문제와 복잡성을 야기했다. 이를 테면, IP를 공유하기 때문에 포트를 할당받을 수 있는데, Borg는 어느 컨테이너에 어떤 포트가 액세스하는지 알아야만 했고 관리가 복잡해졌다고 한다. 영상에서는 다소 길게 설명하고 있는데, <a href="https://pdos.csail.mit.edu/6.824/papers/borg.pdf" target="_blank">Large-scale cluster management at Google with Borg</a> 페이퍼의 <strong>8. Lessons and future work</strong>에서 다음과 같이 언급하고 있다.</p>

<blockquote>
<p><strong>One IP address per machine complicates things</strong> 머신마다 하나의 IP 주소가 일을 복잡하게 만든다. Borg에서 시스템의 모든 작업은 호스트의 단일 IP 주소를 사용하므로 호스트의 포트 공간을 공유한다. 이는 여러가지 어려움을 야기한다. Borg는 포트를 리소스로 예약해야 한다. 태스크는 필요한 포트 수를 미리 선언하고, 시작시 어떤 포트를 사용할 지 알아야만 한다. Linux 네임스페이스, VM, IPv6 및 소프트웨어 정의 네트워킹의 등장으로 인해 Kubernetes는 이러한 복잡성을 제거하는, 보다 사용자 친화적인 접근 방식을 취할 수 있다. 즉, 모든 포드 및 서비스는 고유한 IP 주소를 가지므로, 인프라에서 선택한 포트에 개발자의 소프트웨어를 맞추기 보다는 개발자가 포트를 선택할 수 있고, 포트 관리의 인프라 복잡성을 제거한다.</p>
</blockquote>

<p><strong>Note</strong>: Node IP는 다음과 같이 확인할 수 있다. <code>type</code>에는 <code>ExternalIP</code> 또는 <code>InternalIP</code> 등의 값으로 조회할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get nodes -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[*].status.addresses[?(@.type==&#34;InternalIP&#34;)].address}&#39;</span> <span class="p">|</span> tr -s <span class="s1">&#39;[[:space:]]&#39;</span> <span class="s1">&#39;\n&#39;</span></code></pre></div>
<h2 id="pop간의-연결">Pop간의 연결</h2>

<p>Pod가 서로 고유한 IP 주소를 가지기 때문에, 다음과 같이 한 <code>Pod(192.168.3.140)</code>에서 다른 <code>Pod(192.168.49.6)</code>에 API 요청을 할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl <span class="nb">exec</span> -it kuard-dbdd7955d-4kdbr ash
~ $ wget -O - <span class="m">192</span>.168.49.6:8080/env/api
Connecting to <span class="m">192</span>.168.49.6:8080 <span class="o">(</span><span class="m">192</span>.168.49.6:8080<span class="o">)</span>
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-c48g5&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://192.168.49.6:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://92.168.49.6:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;192.168.49.6&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;192.168.49.6&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
-                    <span class="m">100</span>% <span class="p">|</span>*************************************************************************************************************************<span class="p">|</span>   <span class="m">473</span>   <span class="m">0</span>:00:00 ETA</code></pre></div>
<h2 id="node와-pod간의-연결">Node와 Pod간의 연결</h2>

<p>다음으로, 마스터 노드에 SSH 접속하여 <code>kubectl</code> 명령의 동작 여부를 살펴본다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nv">SSH_KEY</span><span class="o">=</span><span class="s2">&#34;~/.ssh/id_rsa&#34;</span><span class="p">;</span> ssh -i <span class="nv">$SSH_KEY</span> -o <span class="nv">ProxyCommand</span><span class="o">=</span><span class="s2">&#34;ssh -i \&#34;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">\&#34; ubuntu@13.209.11.49 nc %h %p&#34;</span> ubuntu@10.0.23.3</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl get po -o wide
NAME                    READY     STATUS    RESTARTS   AGE       IP              NODE                                            NOMINATED NODE
kuard-dbdd7955d-4kdbr   <span class="m">1</span>/1       Running   <span class="m">0</span>          25m       <span class="m">192</span>.168.3.140   ip-10-0-8-254.ap-northeast-2.compute.internal   &lt;none&gt;
kuard-dbdd7955d-5r757   <span class="m">1</span>/1       Running   <span class="m">0</span>          25m       <span class="m">192</span>.168.49.6    ip-10-0-8-176.ap-northeast-2.compute.internal   &lt;none&gt;
kuard-dbdd7955d-dhts5   <span class="m">1</span>/1       Running   <span class="m">0</span>          25m       <span class="m">192</span>.168.49.9    ip-10-0-8-176.ap-northeast-2.compute.internal   &lt;none&gt;
kuard-dbdd7955d-hsl87   <span class="m">1</span>/1       Running   <span class="m">0</span>          25m       <span class="m">192</span>.168.49.10   ip-10-0-8-176.ap-northeast-2.compute.internal   &lt;none&gt;
kuard-dbdd7955d-k8x7l   <span class="m">1</span>/1       Running   <span class="m">0</span>          25m       <span class="m">192</span>.168.49.8    ip-10-0-8-176.ap-northeast-2.compute.internal   &lt;none&gt;
kuard-dbdd7955d-ms8hb   <span class="m">1</span>/1       Running   <span class="m">0</span>          25m       <span class="m">192</span>.168.3.137   ip-10-0-8-254.ap-northeast-2.compute.internal   &lt;none&gt;
kuard-dbdd7955d-qfjbk   <span class="m">1</span>/1       Running   <span class="m">0</span>          25m       <span class="m">192</span>.168.3.138   ip-10-0-8-254.ap-northeast-2.compute.internal   &lt;none&gt;
kuard-dbdd7955d-tfgdl   <span class="m">1</span>/1       Running   <span class="m">0</span>          25m       <span class="m">192</span>.168.3.136   ip-10-0-8-254.ap-northeast-2.compute.internal   &lt;none&gt;
kuard-dbdd7955d-v8lj2   <span class="m">1</span>/1       Running   <span class="m">0</span>          25m       <span class="m">192</span>.168.3.139   ip-10-0-8-254.ap-northeast-2.compute.internal   &lt;none&gt;
kuard-dbdd7955d-wzcf4   <span class="m">1</span>/1       Running   <span class="m">0</span>          25m       <span class="m">192</span>.168.49.7    ip-10-0-8-176.ap-northeast-2.compute.internal   &lt;none&gt;</code></pre></div>
<p>다음과 같이 Node 인스턴스에서 Pod에 접속이 되는 것을 확인할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ubuntu@ip-10-0-23-3:~/.kube$ curl <span class="m">192</span>.168.3.140:8080/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-4kdbr&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span></code></pre></div>
<p><strong>Note</strong>: 2017년 데모에서는 <code>KUBECONFIG</code> 파일의 명시해주고 있는데, 현재 버전에서는 마스터 노드 홈디렉토리에 <code>~/.kube/config</code> 파일이 존재한다.  <code>kubeadm</code> v1.8.0부터 kubeadm은 클러스터 구성을 kube-system 네임 스페이스의 kubeadm-config라는 ConfigMap에 업로드하고 나중에 업그레이드 할 때 ConfigMap을 읽는다. 그리고 어드민 설정 정보는 <code>/etc/kubernetes/admin.confg</code> 파일에 기록된다.</p>

<ul>
<li>~/.kube/config</li>
<li>/etc/kubernetes/admin.config</li>
</ul>

<p>데모 영상에 나온 질문 몇가지에 대한 답변을 다음과 같이 간단히 요약하였다.</p>

<ul>
<li>AWS 네이티브 라우팅을 이용해서 Kubernetes 클러스터의 노드가 아니어도 클러스터 네트워크에 조인하여 연결될 수 있다.</li>
<li>Pod을 일반적인 호스트처럼 바로 IP 어드레싱을 할 수 있지만, 대부분 Service나 Isto 서비스 메쉬를 통한다. 물론, Service 없이 할 수도 있다. 그러나 자체의 진보된 서비스 디스커버리 매커니즘이 필요할 것이다.</li>
</ul>

<h1 id="cni">CNI</h1>

<p>다음으로 CNI에 대해 설명하고 잇다. CNI는 Kubernetes 컨텍스트가 아니더라도, 많은 컨테이너가 있고 그들 사이의 네트워킹을 구성해야 한다면, 표준 인터페이스로 사용할 수 있다.</p>

<p>다음과 같이 CloudFormation에 명시한 Calico 플러그인 정보는 아래 경로에서 확인할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ubuntu@ip-10-0-23-3:~$ <span class="nb">cd</span> /etc/cni/net.d/
ubuntu@ip-10-0-23-3:/etc/cni/net.d$ ls
<span class="m">10</span>-calico.conflist  calico-kubeconfig</code></pre></div>
<p><code>10-calico.conflist</code>을 보면, Pod 네트워크에 Calio 플러그인을 사용할 것을 명시하고 있다. IPAM 주소 관리는 <code>calico-ipam</code>을 사용한다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ubuntu@ip-10-0-23-3:/etc/cni/net.d$ cat <span class="m">10</span>-calico.conflist 
<span class="o">{</span>
  <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;k8s-pod-network&#34;</span>,
  <span class="s2">&#34;cniVersion&#34;</span>: <span class="s2">&#34;0.3.0&#34;</span>,
  <span class="s2">&#34;plugins&#34;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;calico&#34;</span>,
      <span class="s2">&#34;log_level&#34;</span>: <span class="s2">&#34;info&#34;</span>,
      <span class="s2">&#34;etcd_endpoints&#34;</span>: <span class="s2">&#34;http://10.96.232.136:6666&#34;</span>,
      <span class="s2">&#34;mtu&#34;</span>: <span class="m">1500</span>,
      <span class="s2">&#34;ipam&#34;</span>: <span class="o">{</span>
          <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;calico-ipam&#34;</span>
      <span class="o">}</span>,
      <span class="s2">&#34;policy&#34;</span>: <span class="o">{</span>
          <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;k8s&#34;</span>
      <span class="o">}</span>,
      <span class="s2">&#34;kubernetes&#34;</span>: <span class="o">{</span>
          <span class="s2">&#34;kubeconfig&#34;</span>: <span class="s2">&#34;/etc/cni/net.d/calico-kubeconfig&#34;</span>
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;portmap&#34;</span>,
      <span class="s2">&#34;snat&#34;</span>: true,
      <span class="s2">&#34;capabilities&#34;</span>: <span class="o">{</span><span class="s2">&#34;portMappings&#34;</span>: true<span class="o">}</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span></code></pre></div>
<p>calico API를 호출시 사용되는 Kubernetes 설정 내용이다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ubuntu@ip-10-0-23-3:/etc/cni/net.d$ sudo cat calico-kubeconfig 
<span class="c1"># Kubeconfig file for Calico CNI plugin.
</span><span class="c1"></span>apiVersion: v1
kind: Config
clusters:
- name: <span class="nb">local</span>
  cluster:
    server: https://<span class="o">[</span><span class="m">10</span>.96.0.1<span class="o">]</span>:443
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JS...S0tLQo<span class="o">=</span>
users:
- name: calico
  user:
    token: <span class="s2">&#34;eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc...&#34;</span>
contexts:
- name: calico-context
  context:
    cluster: <span class="nb">local</span>
    user: calico
current-context: calico-context</code></pre></div>
<p>컨테이너로 해야할 어떤 작업이 있을 때마다 플러그인이 호출된다고 한다. 컨테이너의 여러 인터페이스에 대해 여러 개의 플러그인을 구성할 수 있다. 예를 들면, 컨테이너를 런칭할 때, 도커는 내부에 네트워크 네임스페이스를 셋업하는데, CNI는 도커의 모든 네트워크 설정을 가져와 도커와 마찬가지로 네임스페이스 설정을 한 뒤에 Kubernetes의 플러그형 시스템으로 확장하는 역할을 한다고 한다. (CNI에 대해 좀 더 기대했으나 위와 같이 간략하게 설명하고 있다.)</p>

<p><code>/opt/cni/bin</code>으로 이동하면, 여러가지 CNI 배포 패키지들을 볼 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ubuntu@ip-10-0-23-3: <span class="nb">cd</span> /opt/cni/bin
ubuntu@ip-10-0-23-3:/opt/cni/bin$ ls
bridge  calico  calico-ipam  dhcp  flannel  host-local  ipvlan  loopback  macvlan  portmap  ptp  sample  tuning  vlan</code></pre></div>
<p><code>calico</code>를 실행해보자.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ubuntu@ip-10-0-23-3:/opt/cni/bin$ ./calico
CNI_COMMAND env variable missing
<span class="o">{</span>
    <span class="s2">&#34;code&#34;</span>: <span class="m">100</span>,
    <span class="s2">&#34;msg&#34;</span>: <span class="s2">&#34;required env variables missing&#34;</span>
<span class="o">}</span></code></pre></div>
<p>에러를 반환한다. 위에서 보다시피 CNI에 대한 API 호출은 여러가지 환경설정 변수를 넘겨주는데, CNI는 다른 UNIX 네트워킹 프로세스를 셋업할 수 있는 API 호출이라는 것을 알 수 있다.</p>

<h1 id="service">Service</h1>

<p>다음 명령은 <code>type</code>이 <code>LoadBalancer</code>이고, 이름이 <code>kuard</code>인 Service를 생성하여 Kubernetes 클러스터 내의 Pod을 클러스터 외부 로드 밸런서와 연결시킨다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl expose deployment kuard --type<span class="o">=</span>LoadBalancer --target-port<span class="o">=</span><span class="m">8080</span> --port<span class="o">=</span><span class="m">80</span></code></pre></div>
<p>Service와 Pop은 서로에 대해 알지 못하나 Pod의 <code>label</code>로 Service와 Pod이 서로 코디네이션된다. (<code>label</code>을 통해 매핑되는 Service와 Pod의 메카니즘에 대해 설명하고 있는 자료가 이미 많으므로 넘어가기로 한다.)</p>

<p>서비스에는 다음과 같이 4가지 타입이 있다.</p>

<ul>
<li>ExternalName</li>
<li>None</li>
<li>ClusterIP</li>
<li>NodePort</li>
<li>LoadBalancer</li>
</ul>

<h2 id="externalname">ExternalName</h2>

<p><code>ExternalName</code> 타입은 Kubernetes의 자체 서비스 디스커버리을 사용하되, Kubernetes 외부의 이름을 가리키는 Service를 생성한다. Kubernetes 내부와 외부를 매핑시켜줄 때 사용한다. (알다시피, <a href="https://github.com/kubernetes-incubator/external-dns" target="_blank">external-dns</a>를 애드온을 연동하게 되면 AWS, GCP 등의 DNS와 매핑된다.)</p>

<h2 id="none">None</h2>

<p>Service 타입이 None인 경우는 named label query가 되는 기저 레벨이라고 볼 수 있다.</p>

<p><code>None</code> 타입으로 선언한 Service의 내용은 다음과 같이 확인할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl expose deployment kuard --type<span class="o">=</span>None --target-port<span class="o">=</span><span class="m">8080</span> --port<span class="o">=</span><span class="m">80</span> -o yaml --dry-run</code></pre></div>
<p><code>type</code>의 값이 <code>None</code>이고 이름이 <code>kuard</code>인 Service이다.</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>creationTimestamp<span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>ports<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>port<span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span>protocol<span class="p">:</span><span class="w"> </span>TCP<span class="w">
</span><span class="w">    </span>targetPort<span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>type<span class="p">:</span><span class="w"> </span>None<span class="w">
</span><span class="w"></span>status<span class="p">:</span><span class="w">
</span><span class="w">  </span>loadBalancer<span class="p">:</span><span class="w"> </span>{}</code></pre></div>
<p>그리고 Kubernetes 상에서 <code>kuard</code>라는 <code>Service</code>는 다음과 같은 <code>Endpoints</code>로 디코딩된다.</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># $ kubectl get endpoints kuard</span><span class="w">
</span><span class="w"></span>apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Endpoints<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>creationTimestamp<span class="p">:</span><span class="w"> </span><span class="ld">2019-01-18T07:57:55Z</span><span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">  </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;10106&#34;</span><span class="w">
</span><span class="w">  </span>selfLink<span class="p">:</span><span class="w"> </span>/api/v1/namespaces/default/endpoints/kuard<span class="w">
</span><span class="w">  </span>uid<span class="p">:</span><span class="w"> </span>c395caf3-1af6-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w"></span>subsets<span class="p">:</span><span class="w">
</span><span class="w"></span>-<span class="w"> </span>addresses<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>ip<span class="p">:</span><span class="w"> </span><span class="m">192.168</span>.<span class="m">3.136</span><span class="w">
</span><span class="w">    </span>nodeName<span class="p">:</span><span class="w"> </span>ip-<span class="m">10</span>-<span class="m">0</span>-<span class="m">8</span>-<span class="m">254.</span>ap-northeast-<span class="m">2.</span>compute.internal<span class="w">
</span><span class="w">    </span>targetRef<span class="p">:</span><span class="w">
</span><span class="w">      </span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kuard-dbdd7955d-tfgdl<span class="w">
</span><span class="w">      </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">      </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1935&#34;</span><span class="w">
</span><span class="w">      </span>uid<span class="p">:</span><span class="w"> </span>411010f3-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>ip<span class="p">:</span><span class="w"> </span><span class="m">192.168</span>.<span class="m">3.137</span><span class="w">
</span><span class="w">    </span>nodeName<span class="p">:</span><span class="w"> </span>ip-<span class="m">10</span>-<span class="m">0</span>-<span class="m">8</span>-<span class="m">254.</span>ap-northeast-<span class="m">2.</span>compute.internal<span class="w">
</span><span class="w">    </span>targetRef<span class="p">:</span><span class="w">
</span><span class="w">      </span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kuard-dbdd7955d-ms8hb<span class="w">
</span><span class="w">      </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">      </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1938&#34;</span><span class="w">
</span><span class="w">      </span>uid<span class="p">:</span><span class="w"> </span>4108db60-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>ip<span class="p">:</span><span class="w"> </span><span class="m">192.168</span>.<span class="m">3.138</span><span class="w">
</span><span class="w">    </span>nodeName<span class="p">:</span><span class="w"> </span>ip-<span class="m">10</span>-<span class="m">0</span>-<span class="m">8</span>-<span class="m">254.</span>ap-northeast-<span class="m">2.</span>compute.internal<span class="w">
</span><span class="w">    </span>targetRef<span class="p">:</span><span class="w">
</span><span class="w">      </span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kuard-dbdd7955d-qfjbk<span class="w">
</span><span class="w">      </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">      </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1949&#34;</span><span class="w">
</span><span class="w">      </span>uid<span class="p">:</span><span class="w"> </span>410b40b7-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>ip<span class="p">:</span><span class="w"> </span><span class="m">192.168</span>.<span class="m">3.139</span><span class="w">
</span><span class="w">    </span>nodeName<span class="p">:</span><span class="w"> </span>ip-<span class="m">10</span>-<span class="m">0</span>-<span class="m">8</span>-<span class="m">254.</span>ap-northeast-<span class="m">2.</span>compute.internal<span class="w">
</span><span class="w">    </span>targetRef<span class="p">:</span><span class="w">
</span><span class="w">      </span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kuard-dbdd7955d-v8lj2<span class="w">
</span><span class="w">      </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">      </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1965&#34;</span><span class="w">
</span><span class="w">      </span>uid<span class="p">:</span><span class="w"> </span>41102fed-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>ip<span class="p">:</span><span class="w"> </span><span class="m">192.168</span>.<span class="m">3.140</span><span class="w">
</span><span class="w">    </span>nodeName<span class="p">:</span><span class="w"> </span>ip-<span class="m">10</span>-<span class="m">0</span>-<span class="m">8</span>-<span class="m">254.</span>ap-northeast-<span class="m">2.</span>compute.internal<span class="w">
</span><span class="w">    </span>targetRef<span class="p">:</span><span class="w">
</span><span class="w">      </span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kuard-dbdd7955d-4kdbr<span class="w">
</span><span class="w">      </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">      </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1982&#34;</span><span class="w">
</span><span class="w">      </span>uid<span class="p">:</span><span class="w"> </span>411761d7-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>ip<span class="p">:</span><span class="w"> </span><span class="m">192.168</span>.<span class="m">49.10</span><span class="w">
</span><span class="w">    </span>nodeName<span class="p">:</span><span class="w"> </span>ip-<span class="m">10</span>-<span class="m">0</span>-<span class="m">8</span>-<span class="m">176.</span>ap-northeast-<span class="m">2.</span>compute.internal<span class="w">
</span><span class="w">    </span>targetRef<span class="p">:</span><span class="w">
</span><span class="w">      </span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kuard-dbdd7955d-hsl87<span class="w">
</span><span class="w">      </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">      </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1985&#34;</span><span class="w">
</span><span class="w">      </span>uid<span class="p">:</span><span class="w"> </span>41177ccd-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>ip<span class="p">:</span><span class="w"> </span><span class="m">192.168</span>.<span class="m">49.6</span><span class="w">
</span><span class="w">    </span>nodeName<span class="p">:</span><span class="w"> </span>ip-<span class="m">10</span>-<span class="m">0</span>-<span class="m">8</span>-<span class="m">176.</span>ap-northeast-<span class="m">2.</span>compute.internal<span class="w">
</span><span class="w">    </span>targetRef<span class="p">:</span><span class="w">
</span><span class="w">      </span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kuard-dbdd7955d-5r757<span class="w">
</span><span class="w">      </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">      </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1952&#34;</span><span class="w">
</span><span class="w">      </span>uid<span class="p">:</span><span class="w"> </span><span class="m">41102166</span>-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>ip<span class="p">:</span><span class="w"> </span><span class="m">192.168</span>.<span class="m">49.7</span><span class="w">
</span><span class="w">    </span>nodeName<span class="p">:</span><span class="w"> </span>ip-<span class="m">10</span>-<span class="m">0</span>-<span class="m">8</span>-<span class="m">176.</span>ap-northeast-<span class="m">2.</span>compute.internal<span class="w">
</span><span class="w">    </span>targetRef<span class="p">:</span><span class="w">
</span><span class="w">      </span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kuard-dbdd7955d-wzcf4<span class="w">
</span><span class="w">      </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">      </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1962&#34;</span><span class="w">
</span><span class="w">      </span>uid<span class="p">:</span><span class="w"> </span>41178be2-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>ip<span class="p">:</span><span class="w"> </span><span class="m">192.168</span>.<span class="m">49.8</span><span class="w">
</span><span class="w">    </span>nodeName<span class="p">:</span><span class="w"> </span>ip-<span class="m">10</span>-<span class="m">0</span>-<span class="m">8</span>-<span class="m">176.</span>ap-northeast-<span class="m">2.</span>compute.internal<span class="w">
</span><span class="w">    </span>targetRef<span class="p">:</span><span class="w">
</span><span class="w">      </span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kuard-dbdd7955d-k8x7l<span class="w">
</span><span class="w">      </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">      </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1969&#34;</span><span class="w">
</span><span class="w">      </span>uid<span class="p">:</span><span class="w"> </span>410b5dad-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>ip<span class="p">:</span><span class="w"> </span><span class="m">192.168</span>.<span class="m">49.9</span><span class="w">
</span><span class="w">    </span>nodeName<span class="p">:</span><span class="w"> </span>ip-<span class="m">10</span>-<span class="m">0</span>-<span class="m">8</span>-<span class="m">176.</span>ap-northeast-<span class="m">2.</span>compute.internal<span class="w">
</span><span class="w">    </span>targetRef<span class="p">:</span><span class="w">
</span><span class="w">      </span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>kuard-dbdd7955d-dhts5<span class="w">
</span><span class="w">      </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">      </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1977&#34;</span><span class="w">
</span><span class="w">      </span>uid<span class="p">:</span><span class="w"> </span>410ff0b5-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w">  </span>ports<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>port<span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">    </span>protocol<span class="p">:</span><span class="w"> </span>TCP</code></pre></div>
<p>보다시피 <code>kuard</code> 엔드포인트의 프로토콜은 <code>TCP</code>, 포트는 <code>8080</code>,그리고 <code>kuard</code> Pod에 대한 여러 IP 주소의 집합으로 구성되어 있다. Pop의 헬스체크로 인해 Pod이 죽었다고 판단될 경우, 엔드포인트에서는 보이지 않게 된다. 즉, 일종의 Sanity Filtering이 동작하는 것으로, 서비스 디스커버리가 동작하는 기본적인 메카니즘이라 할 수 있다.</p>

<h2 id="clusterip">ClusterIP</h2>

<p>현재 <code>kuard</code> Service를 보면, <code>clusterIP</code>는 <code>10.97.169.67</code>로 잡혀 있다. 이는 가상 IP이고, 서비스의 라이프사이클 동안 변하지 않는다.</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># kubectl get svc kuard -o yaml</span><span class="w">
</span><span class="w"></span>apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>creationTimestamp<span class="p">:</span><span class="w"> </span><span class="ld">2019-01-18T13:22:28Z</span><span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">  </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;7842&#34;</span><span class="w">
</span><span class="w">  </span>selfLink<span class="p">:</span><span class="w"> </span>/api/v1/namespaces/default/services/kuard<span class="w">
</span><span class="w">  </span>uid<span class="p">:</span><span class="w"> </span>1a7df4fb-1b24-<span class="m">11e9</span>-a27c-02b8e4b61ab8<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>clusterIP<span class="p">:</span><span class="w"> </span><span class="m">10.97</span>.<span class="m">169.67</span><span class="w">
</span><span class="w">  </span>externalTrafficPolicy<span class="p">:</span><span class="w"> </span>Cluster<span class="w">
</span><span class="w">  </span>ports<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>nodePort<span class="p">:</span><span class="w"> </span><span class="m">31986</span><span class="w">
</span><span class="w">    </span>port<span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span>protocol<span class="p">:</span><span class="w"> </span>TCP<span class="w">
</span><span class="w">    </span>targetPort<span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>sessionAffinity<span class="p">:</span><span class="w"> </span>None<span class="w">
</span><span class="w">  </span>type<span class="p">:</span><span class="w"> </span>LoadBalancer<span class="w">
</span><span class="w"></span>status<span class="p">:</span><span class="w">
</span><span class="w">  </span>loadBalancer<span class="p">:</span><span class="w">
</span><span class="w">    </span>ingress<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>hostname<span class="p">:</span><span class="w"> </span>a1a7df4fb1b2411e9a27c02b8e4b61ab-<span class="m">1083762423.</span>ap-northeast-<span class="m">2.</span>elb.amazonaws.com</code></pre></div>
<p>좀 더 자세히 알아보기 위해, 클러스터 마스터 내부에 접속한다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nv">SSH_KEY</span><span class="o">=</span><span class="s2">&#34;~/.ssh/id_rsa&#34;</span><span class="p">;</span> ssh -i <span class="nv">$SSH_KEY</span> -A -L8080:localhost:8080 -o <span class="nv">ProxyCommand</span><span class="o">=</span><span class="s2">&#34;ssh -i \&#34;</span><span class="si">${</span><span class="nv">SSH_KEY</span><span class="si">}</span><span class="s2">\&#34; ubuntu@13.125.51.126 nc %h %p&#34;</span> ubuntu@10.0.18.181

<span class="c1">###############################################################
</span><span class="c1">#       _   _            _   _         _    ___               #
</span><span class="c1">#      | | | | ___ _ __ | |_(_) ___   | | _( _ ) ___          #
</span><span class="c1">#      | |_| |/ _ \ &#39;_ \| __| |/ _ \  | |/ / _ \/ __|         #
</span><span class="c1">#      |  _  |  __/ |_) | |_| | (_) | |   &lt; (_) \__ \         #
</span><span class="c1">#      |_| |_|\___| .__/ \__|_|\___/  |_|\_\___/|___/         #
</span><span class="c1">#                 |_|                                         #
</span><span class="c1">#        ___        _      _     ____  _             _        #
</span><span class="c1">#       / _ \ _   _(_) ___| | __/ ___|| |_ __ _ _ __| |_      #
</span><span class="c1">#      | | | | | | | |/ __| |/ /\___ \| __/ _` | &#39;__| __|     #
</span><span class="c1">#      | |_| | |_| | | (__|   &lt;  ___) | || (_| | |  | |_      #
</span><span class="c1">#       \__\_\\__,_|_|\___|_|\_\|____/ \__\__,_|_|   \__|     #
</span><span class="c1">#                                                             #
</span><span class="c1">###############################################################
</span><span class="c1"></span>Welcome to Ubuntu <span class="m">16</span>.04.5 LTS <span class="o">(</span>GNU/Linux <span class="m">4</span>.4.0-1072-aws x86_64<span class="o">)</span>

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  Get cloud support with Ubuntu Advantage Cloud Guest:
    http://www.ubuntu.com/business/services/cloud
This system has been minimized by removing packages and content that are
not required on a system that users <span class="k">do</span> not log into.

To restore this content, you can run the <span class="s1">&#39;unminimize&#39;</span> command.

<span class="m">38</span> packages can be updated.
<span class="m">0</span> updates are security updates.

New release <span class="s1">&#39;18.04.1 LTS&#39;</span> available.
Run <span class="s1">&#39;do-release-upgrade&#39;</span> to upgrade to it.

*** System restart required ***
ubuntu@ip-10-0-18-181:~$</code></pre></div>
<p>위와 같이 마스터 노드에 진입해서 <code>kube-system</code> 네임스페이스의 Pod을 조회하면, 각 노드마다 <code>kube-proxy</code>라는 DaemonSet이 실행 중인 것을 알 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ubuntu@ip-10-0-18-181:~$ kubectl get pod --namespace<span class="o">=</span>kube-system
NAME                                                                     READY     STATUS    RESTARTS   AGE
calico-etcd-twh4d                                                        <span class="m">1</span>/1       Running   <span class="m">0</span>          2h
calico-kube-controllers-b798bfc9c-qzdzn                                  <span class="m">1</span>/1       Running   <span class="m">0</span>          2h
calico-node-b7w5v                                                        <span class="m">2</span>/2       Running   <span class="m">0</span>          2h
calico-node-bxhxx                                                        <span class="m">2</span>/2       Running   <span class="m">2</span>          1h
calico-node-smrvg                                                        <span class="m">2</span>/2       Running   <span class="m">2</span>          1h
coredns-78fcdf6894-fpt2m                                                 <span class="m">1</span>/1       Running   <span class="m">0</span>          2h
coredns-78fcdf6894-m2zsn                                                 <span class="m">1</span>/1       Running   <span class="m">0</span>          2h
etcd-ip-10-0-18-181.ap-northeast-2.compute.internal                      <span class="m">1</span>/1       Running   <span class="m">0</span>          1h
kube-apiserver-ip-10-0-18-181.ap-northeast-2.compute.internal            <span class="m">1</span>/1       Running   <span class="m">0</span>          1h
kube-controller-manager-ip-10-0-18-181.ap-northeast-2.compute.internal   <span class="m">1</span>/1       Running   <span class="m">0</span>          1h
kube-proxy-f9q76                                                         <span class="m">1</span>/1       Running   <span class="m">0</span>          1h
kube-proxy-m5sqz                                                         <span class="m">1</span>/1       Running   <span class="m">0</span>          1h
kube-proxy-pnxwv                                                         <span class="m">1</span>/1       Running   <span class="m">0</span>          1h
kube-scheduler-ip-10-0-18-181.ap-northeast-2.compute.internal            <span class="m">1</span>/1       Running   <span class="m">0</span>          1h
kubernetes-dashboard-84fff45879-cmmtp                                    <span class="m">1</span>/1       Running   <span class="m">0</span>          2h</code></pre></div>
<p><code>kube-proxy</code>의 메커니즘은 다음과 같다. <code>kube-proxy</code>는 ClusterIP를 지닌 모든 <code>Service</code>를 모니터링한다. 그리고 연관된 <code>EndPoint</code> 변경을 따라 iptable을 구성하고, 해당 iptable을 사용해서 ClusterIP를 통하는 모든 트래픽이 해당하는 엔드포인트에 랜덤하게 로드 밸런싱되게 한다.</p>

<p>iptable을 살펴보자. calico가 관리하는 iptable은 <code>cali</code>라고 주석이 달려 있다.</p>

<p><details>
<summary><code>iptables -L</code></summary></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ iptables -L
Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
cali-INPUT  all  --  anywhere             anywhere             /* cali:Cz_u1IQiXIMmKD4c */
KUBE-EXTERNAL-SERVICES  all  --  anywhere             anywhere             ctstate NEW /* kubernetes externally-visible service portals */
KUBE-FIREWALL  all  --  anywhere             anywhere            

Chain FORWARD <span class="o">(</span>policy DROP<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
cali-FORWARD  all  --  anywhere             anywhere             /* cali:wUHhoiAYhphO9Mso */
KUBE-FORWARD  all  --  anywhere             anywhere             /* kubernetes forwarding rules */
DOCKER-ISOLATION  all  --  anywhere             anywhere            
DOCKER     all  --  anywhere             anywhere            
ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
ACCEPT     all  --  anywhere             anywhere            
ACCEPT     all  --  anywhere             anywhere            

Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
cali-OUTPUT  all  --  anywhere             anywhere             /* cali:tVnHkvAo15HuiPy0 */
KUBE-SERVICES  all  --  anywhere             anywhere             ctstate NEW /* kubernetes service portals */
KUBE-FIREWALL  all  --  anywhere             anywhere            

Chain DOCKER <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         

Chain DOCKER-ISOLATION <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
RETURN     all  --  anywhere             anywhere            

Chain KUBE-EXTERNAL-SERVICES <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         

Chain KUBE-FIREWALL <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
DROP       all  --  anywhere             anywhere             /* kubernetes firewall <span class="k">for</span> dropping marked packets */ mark match 0x8000/0x8000

Chain KUBE-FORWARD <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     all  --  anywhere             anywhere             /* kubernetes forwarding rules */ mark match 0x4000/0x4000
ACCEPT     all  --  ip-192-168-0-0.ap-northeast-2.compute.internal/16  anywhere             /* kubernetes forwarding conntrack pod <span class="nb">source</span> rule */ ctstate RELATED,ESTABLISHED
ACCEPT     all  --  anywhere             ip-192-168-0-0.ap-northeast-2.compute.internal/16  /* kubernetes forwarding conntrack pod destination rule */ ctstate RELATED,ESTABLISHED

Chain KUBE-SERVICES <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         

Chain cali-FORWARD <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
MARK       all  --  anywhere             anywhere             /* cali:vjrMJCRpqwy5oRoX */ MARK and 0xfff1ffff
cali-from-hep-forward  all  --  anywhere             anywhere             /* cali:A_sPAO0mcxbT9mOV */ mark match 0x0/0x10000
cali-from-wl-dispatch  all  --  anywhere             anywhere             /* cali:8ZoYfO5HKXWbB3pk */
cali-to-wl-dispatch  all  --  anywhere             anywhere             /* cali:jdEuaPBe14V2hutn */
cali-to-hep-forward  all  --  anywhere             anywhere             /* cali:12bc6HljsMKsmfr- */
ACCEPT     all  --  anywhere             anywhere             /* cali:MH9kMp5aNICL-Olv */ /* Policy explicitly accepted packet. */ mark match 0x10000/0x10000

Chain cali-INPUT <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     all  --  anywhere             anywhere             /* cali:msRIDfJRWnYwzW4g */ mark match 0x10000/0x10000
ACCEPT     ipencap--  anywhere             anywhere             /* cali:1IRlRis1-pHsGnX5 */ /* Allow IPIP packets from Calico hosts */ match-set cali40all-hosts-net src ADDRTYPE match dst-type LOCAL
DROP       ipencap--  anywhere             anywhere             /* cali:jX63A0VGotRJWnUL */ /* Drop IPIP packets from non-Calico hosts */
cali-wl-to-host  all  --  anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>  /* cali:Dit8xicL3zTIYYlp */
MARK       all  --  anywhere             anywhere             /* cali:LCGWUV2ju3tJmfW0 */ MARK and 0xfff0ffff
cali-from-host-endpoint  all  --  anywhere             anywhere             /* cali:x-gEznubq2huN2Fo */
ACCEPT     all  --  anywhere             anywhere             /* cali:m27NaAhoKHLs1plD */ /* Host endpoint policy accepted packet. */ mark match 0x10000/0x10000

Chain cali-OUTPUT <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     all  --  anywhere             anywhere             /* cali:Mq1_rAdXXH3YkrzW */ mark match 0x10000/0x10000
RETURN     all  --  anywhere             anywhere             /* cali:69FkRTJDvD5Vu6Vl */
ACCEPT     ipencap--  anywhere             anywhere             /* cali:AnEsmO6bDZbQntWW */ /* Allow IPIP packets to other Calico hosts */ match-set cali40all-hosts-net dst ADDRTYPE match src-type LOCAL
MARK       all  --  anywhere             anywhere             /* cali:9e9Uf3GU5tX--Lxy */ MARK and 0xfff0ffff
cali-to-host-endpoint  all  --  anywhere             anywhere             /* cali:OB2pzPrvQn6PC89t */
ACCEPT     all  --  anywhere             anywhere             /* cali:tvSSMDBWrme3CUqM */ /* Host endpoint policy accepted packet. */ mark match 0x10000/0x10000

Chain cali-failsafe-in <span class="o">(</span><span class="m">0</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     tcp  --  anywhere             anywhere             /* cali:wWFQM43tJU7wwnFZ */ multiport dports ssh
ACCEPT     udp  --  anywhere             anywhere             /* cali:LwNV--R8MjeUYacw */ multiport dports bootpc
ACCEPT     tcp  --  anywhere             anywhere             /* cali:QOO5NUOqOSS1_Iw0 */ multiport dports bgp
ACCEPT     tcp  --  anywhere             anywhere             /* cali:cwZWoBSwVeIAZmVN */ multiport dports <span class="m">2379</span>
ACCEPT     tcp  --  anywhere             anywhere             /* cali:7FbNXT91kugE_upR */ multiport dports <span class="m">2380</span>
ACCEPT     tcp  --  anywhere             anywhere             /* cali:ywE9WYUBEpve70WT */ multiport dports <span class="m">6666</span>
ACCEPT     tcp  --  anywhere             anywhere             /* cali:l-WQSVBf_lygPR0J */ multiport dports ircd

Chain cali-failsafe-out <span class="o">(</span><span class="m">0</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     udp  --  anywhere             anywhere             /* cali:82hjfji-wChFhAqL */ multiport dports domain
ACCEPT     udp  --  anywhere             anywhere             /* cali:TNM3RfEjbNr72hgH */ multiport dports bootps
ACCEPT     tcp  --  anywhere             anywhere             /* cali:ycxKitIl4u3dK0HR */ multiport dports bgp
ACCEPT     tcp  --  anywhere             anywhere             /* cali:hxjEWyxdkXXkdvut */ multiport dports <span class="m">2379</span>
ACCEPT     tcp  --  anywhere             anywhere             /* cali:cA_GLtruuvG88KiO */ multiport dports <span class="m">2380</span>
ACCEPT     tcp  --  anywhere             anywhere             /* cali:Sb1hkLYFMrKS6r01 */ multiport dports <span class="m">6666</span>
ACCEPT     tcp  --  anywhere             anywhere             /* cali:UwLSebGONJUG4yG- */ multiport dports ircd

Chain cali-from-hep-forward <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         

Chain cali-from-host-endpoint <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         

Chain cali-from-wl-dispatch <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
cali-fw-cali82a8bb394bd  all  --  anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>  /* cali:iec6Icru0K37idwj */
cali-fw-calie930c422661  all  --  anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>  /* cali:0jlZAcGo54oqY8p3 */
cali-fw-calif3533dd3229  all  --  anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>  /* cali:PUv0YBkan3WHQZix */
DROP       all  --  anywhere             anywhere             /* cali:-ojO7WWmz0kbfddZ */ /* Unknown interface */

Chain cali-fw-cali82a8bb394bd <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     all  --  anywhere             anywhere             /* cali:rEFkHFBfSpqnudiF */ ctstate RELATED,ESTABLISHED
DROP       all  --  anywhere             anywhere             /* cali:cMimONNlTtpLzwFn */ ctstate INVALID
MARK       all  --  anywhere             anywhere             /* cali:ScMWqdtSYj6jUbqB */ MARK and 0xfffeffff
cali-pro-kns.kube-system  all  --  anywhere             anywhere             /* cali:fcyxR3eYmhq2xDwn */
RETURN     all  --  anywhere             anywhere             /* cali:XkAXtVVx5l-JkBR_ */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
cali-pro-_u2Tn2rSoAPffvE7JO6  all  --  anywhere             anywhere             /* cali:gHae-WfoqhPTeoWZ */
RETURN     all  --  anywhere             anywhere             /* cali:kFr4XE5funBdyddk */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
DROP       all  --  anywhere             anywhere             /* cali:XGKyCDMWXBQivuzk */ /* Drop <span class="k">if</span> no profiles matched */

Chain cali-fw-calie930c422661 <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     all  --  anywhere             anywhere             /* cali:9GO__AFzeIKKpkC3 */ ctstate RELATED,ESTABLISHED
DROP       all  --  anywhere             anywhere             /* cali:PJ-pgay_zq2Qslnb */ ctstate INVALID
MARK       all  --  anywhere             anywhere             /* cali:ogTm-kn-NPg6zYsd */ MARK and 0xfffeffff
cali-pro-kns.kube-system  all  --  anywhere             anywhere             /* cali:MR5-EG6LT-4FQVHs */
RETURN     all  --  anywhere             anywhere             /* cali:eSbE3QKgYjrONve7 */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
cali-pro-_be-1GnaHI4zA9ZiNqb  all  --  anywhere             anywhere             /* cali:M1HNVqvcGyE94Nvw */
RETURN     all  --  anywhere             anywhere             /* cali:jGOTAMwTGCI4OWPX */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
DROP       all  --  anywhere             anywhere             /* cali:LOtk7YMg5IrVV3BH */ /* Drop <span class="k">if</span> no profiles matched */

Chain cali-fw-calif3533dd3229 <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     all  --  anywhere             anywhere             /* cali:YH57UrJxw-tOmJKr */ ctstate RELATED,ESTABLISHED
DROP       all  --  anywhere             anywhere             /* cali:IE-8xOX07E7Owz-K */ ctstate INVALID
MARK       all  --  anywhere             anywhere             /* cali:jVx41uBbKJHbN4OU */ MARK and 0xfffeffff
cali-pro-kns.kube-system  all  --  anywhere             anywhere             /* cali:UYWxLdAe9bsLem-b */
RETURN     all  --  anywhere             anywhere             /* cali:LtqfyPifkDfH-orx */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
cali-pro-_u2Tn2rSoAPffvE7JO6  all  --  anywhere             anywhere             /* cali:mr7YiskIpUpprX35 */
RETURN     all  --  anywhere             anywhere             /* cali:O0-SshHUwmCNJ8Cx */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
DROP       all  --  anywhere             anywhere             /* cali:_NyR6RmRKEMmc0Sr */ /* Drop <span class="k">if</span> no profiles matched */

Chain cali-pi-_vOsBt0qc8GM-JXGkiMn <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         

Chain cali-po-_vOsBt0qc8GM-JXGkiMn <span class="o">(</span><span class="m">0</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         

Chain cali-pri-_be-1GnaHI4zA9ZiNqb <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
DROP       all  --  anywhere             anywhere             /* cali:YrXwxizPmMHbIOcu */

Chain cali-pri-_u2Tn2rSoAPffvE7JO6 <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
DROP       all  --  anywhere             anywhere             /* cali:3WowQ2oY88d3FWSg */

Chain cali-pri-kns.kube-system <span class="o">(</span><span class="m">3</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
MARK       all  --  anywhere             anywhere             /* cali:zoH5gU6U55FKZxEo */ MARK or 0x10000
RETURN     all  --  anywhere             anywhere             /* cali:bcGRIJcyOS9dgBiB */ mark match 0x10000/0x10000

Chain cali-pro-_be-1GnaHI4zA9ZiNqb <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
DROP       all  --  anywhere             anywhere             /* cali:KGqIRWRYnPNtm88p */

Chain cali-pro-_u2Tn2rSoAPffvE7JO6 <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
DROP       all  --  anywhere             anywhere             /* cali:7uaZJ8EAWrfkGzjv */

Chain cali-pro-kns.kube-system <span class="o">(</span><span class="m">3</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
MARK       all  --  anywhere             anywhere             /* cali:-50oJuMfLVO3LkBk */ MARK or 0x10000
RETURN     all  --  anywhere             anywhere             /* cali:ztVPKv1UYejNzm1g */ mark match 0x10000/0x10000

Chain cali-to-hep-forward <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         

Chain cali-to-host-endpoint <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         

Chain cali-to-wl-dispatch <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
cali-tw-cali82a8bb394bd  all  --  anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>  /* cali:DH1bLyxskFJok8LY */
cali-tw-calie930c422661  all  --  anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>  /* cali:v4KHY3mc1Ym9DiZc */
cali-tw-calif3533dd3229  all  --  anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>  /* cali:Z6Ww2zhhGbh19h6K */
DROP       all  --  anywhere             anywhere             /* cali:EuaJOevUVXhWjfo- */ /* Unknown interface */

Chain cali-tw-cali82a8bb394bd <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     all  --  anywhere             anywhere             /* cali:vrhTi3Nw7kE6Ef5t */ ctstate RELATED,ESTABLISHED
DROP       all  --  anywhere             anywhere             /* cali:jG_UsyATyr-kJ6AQ */ ctstate INVALID
MARK       all  --  anywhere             anywhere             /* cali:FerW_RRGXaa36-vj */ MARK and 0xfffeffff
cali-pri-kns.kube-system  all  --  anywhere             anywhere             /* cali:YKrxQCxGe4eaqLap */
RETURN     all  --  anywhere             anywhere             /* cali:wfbQVtfm0N1ND8R0 */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
cali-pri-_u2Tn2rSoAPffvE7JO6  all  --  anywhere             anywhere             /* cali:9PkEFe9LRMPxCP4K */
RETURN     all  --  anywhere             anywhere             /* cali:i-PGBuetIpieXaJ8 */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
DROP       all  --  anywhere             anywhere             /* cali:43EsNrcTxe_Gut6O */ /* Drop <span class="k">if</span> no profiles matched */

Chain cali-tw-calie930c422661 <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     all  --  anywhere             anywhere             /* cali:tkJMJT3XRZeM-2Gg */ ctstate RELATED,ESTABLISHED
DROP       all  --  anywhere             anywhere             /* cali:hBXm_jQ4g-vOXrvD */ ctstate INVALID
MARK       all  --  anywhere             anywhere             /* cali:wQ2uqXWFYbTHdTqX */ MARK and 0xfffeffff
MARK       all  --  anywhere             anywhere             /* cali:YlnF0m9DiQACjY09 */ /* Start of policies */ MARK and 0xfffdffff
cali-pi-_vOsBt0qc8GM-JXGkiMn  all  --  anywhere             anywhere             /* cali:0LpzqkQs2SGOS_wo */ mark match 0x0/0x20000
RETURN     all  --  anywhere             anywhere             /* cali:xr1W-9np6ixXUzOe */ /* Return <span class="k">if</span> policy accepted */ mark match 0x10000/0x10000
DROP       all  --  anywhere             anywhere             /* cali:DyuQ1f19JvhahmR7 */ /* Drop <span class="k">if</span> no policies passed packet */ mark match 0x0/0x20000
cali-pri-kns.kube-system  all  --  anywhere             anywhere             /* cali:566-vQl_FY43wHvx */
RETURN     all  --  anywhere             anywhere             /* cali:XeFMO_8xxORT_IXy */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
cali-pri-_be-1GnaHI4zA9ZiNqb  all  --  anywhere             anywhere             /* cali:83QDy1HEQkh-KMXt */
RETURN     all  --  anywhere             anywhere             /* cali:XXlZXzitmj5-clZc */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
DROP       all  --  anywhere             anywhere             /* cali:ZMgyCtJ9dKOGThG0 */ /* Drop <span class="k">if</span> no profiles matched */

Chain cali-tw-calif3533dd3229 <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
ACCEPT     all  --  anywhere             anywhere             /* cali:Jp5FpTzoIYgEzVhI */ ctstate RELATED,ESTABLISHED
DROP       all  --  anywhere             anywhere             /* cali:OS4FQ7GDf9nqPGuo */ ctstate INVALID
MARK       all  --  anywhere             anywhere             /* cali:U8S5KlI4JDCzJT2L */ MARK and 0xfffeffff
cali-pri-kns.kube-system  all  --  anywhere             anywhere             /* cali:N7mCGC3NJKTvWJ2_ */
RETURN     all  --  anywhere             anywhere             /* cali:cags8BdhUzZKkCtV */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
cali-pri-_u2Tn2rSoAPffvE7JO6  all  --  anywhere             anywhere             /* cali:LNHtw-GrC3bM44iL */
RETURN     all  --  anywhere             anywhere             /* cali:EhyfxW1SBfAAy2Ec */ /* Return <span class="k">if</span> profile accepted */ mark match 0x10000/0x10000
DROP       all  --  anywhere             anywhere             /* cali:tV1eFXrUQA4xEfFW */ /* Drop <span class="k">if</span> no profiles matched */

Chain cali-wl-to-host <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination         
cali-from-wl-dispatch  all  --  anywhere             anywhere             /* cali:Ee9Sbo10IpVujdIY */
ACCEPT     all  --  anywhere             anywhere             /* cali:nSZbcOoG1xPONxb8 */ /* Configured DefaultEndpointToHostAction */</code></pre></div>
<p></details></p>

<p>다음으로, 포워딩 테이블을 살펴보자.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ iptables-save <span class="p">|</span> less
...
-A KUBE-SERVICES ! -s <span class="m">192</span>.168.0.0/16 -d <span class="m">10</span>.96.0.10/32 -p tcp -m comment --comment <span class="s2">&#34;kube-system/kube-dns:dns-tcp cluster IP&#34;</span> -m tcp --dport <span class="m">53</span> -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d <span class="m">10</span>.96.0.10/32 -p tcp -m comment --comment <span class="s2">&#34;kube-system/kube-dns:dns-tcp cluster IP&#34;</span> -m tcp --dport <span class="m">53</span> -j KUBE-SVC-ERIFXISQEP7F7OF4
-A KUBE-SERVICES ! -s <span class="m">192</span>.168.0.0/16 -d <span class="m">10</span>.96.232.136/32 -p tcp -m comment --comment <span class="s2">&#34;kube-system/calico-etcd: cluster IP&#34;</span> -m tcp --dport <span class="m">6666</span> -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d <span class="m">10</span>.96.232.136/32 -p tcp -m comment --comment <span class="s2">&#34;kube-system/calico-etcd: cluster IP&#34;</span> -m tcp --dport <span class="m">6666</span> -j KUBE-SVC-NTYB37XIWATNM25Y
-A KUBE-SERVICES ! -s <span class="m">192</span>.168.0.0/16 -d <span class="m">10</span>.98.144.55/32 -p tcp -m comment --comment <span class="s2">&#34;kube-system/kubernetes-dashboard: cluster IP&#34;</span> -m tcp --dport <span class="m">443</span> -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d <span class="m">10</span>.98.144.55/32 -p tcp -m comment --comment <span class="s2">&#34;kube-system/kubernetes-dashboard: cluster IP&#34;</span> -m tcp --dport <span class="m">443</span> -j KUBE-SVC-XGLOHA7QRQ3V22RZ
-A KUBE-SERVICES ! -s <span class="m">192</span>.168.0.0/16 -d <span class="m">10</span>.97.169.67/32 -p tcp -m comment --comment <span class="s2">&#34;default/kuard: cluster IP&#34;</span> -m tcp --dport <span class="m">80</span> -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d <span class="m">10</span>.97.169.67/32 -p tcp -m comment --comment <span class="s2">&#34;default/kuard: cluster IP&#34;</span> -m tcp --dport <span class="m">80</span> -j KUBE-SVC-CUXC5A3HHHVSSN62
-A KUBE-SERVICES ! -s <span class="m">192</span>.168.0.0/16 -d <span class="m">10</span>.96.0.1/32 -p tcp -m comment --comment <span class="s2">&#34;default/kubernetes:https cluster IP&#34;</span> -m tcp --dport <span class="m">443</span> -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d <span class="m">10</span>.96.0.1/32 -p tcp -m comment --comment <span class="s2">&#34;default/kubernetes:https cluster IP&#34;</span> -m tcp --dport <span class="m">443</span> -j KUBE-SVC-NPX46M4PTMTKRN6Y
-A KUBE-SERVICES ! -s <span class="m">192</span>.168.0.0/16 -d <span class="m">10</span>.96.0.10/32 -p udp -m comment --comment <span class="s2">&#34;kube-system/kube-dns:dns cluster IP&#34;</span> -m udp --dport <span class="m">53</span> -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d <span class="m">10</span>.96.0.10/32 -p udp -m comment --comment <span class="s2">&#34;kube-system/kube-dns:dns cluster IP&#34;</span> -m udp --dport <span class="m">53</span> -j KUBE-SVC-TCOU7JCQXEZGVUNU
-A KUBE-SERVICES -m comment --comment <span class="s2">&#34;kubernetes service nodeports; NOTE: this must be the last rule in this chain&#34;</span> -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS
...</code></pre></div>
<p>다음과 같이 ip <code>10.97.169.67</code>은 <code>KUBE-SVC-CUXC5A3HHHVSSN62</code>으로 점프한다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">-A KUBE-SERVICES -d <span class="m">10</span>.97.169.67/32 -p tcp -m comment --comment <span class="s2">&#34;default/kuard: cluster IP&#34;</span> -m tcp --dport <span class="m">80</span> -j KUBE-SVC-CUXC5A3HHHVSSN62</code></pre></div>
<p><code>KUBE-SVC-CUXC5A3HHHVSSN62</code>을 살펴보면, 랜덤 확률별로 각각의 규칙으로 점프하는 것을 알 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">-A KUBE-SVC-CUXC5A3HHHVSSN62 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -m statistic --mode random --probability <span class="m">0</span>.10000000009 -j KUBE-SEP-IY5EMZGCCC7HUEGX
-A KUBE-SVC-CUXC5A3HHHVSSN62 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -m statistic --mode random --probability <span class="m">0</span>.11110999994 -j KUBE-SEP-JBD3W2H2CSU7KYVR
-A KUBE-SVC-CUXC5A3HHHVSSN62 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -m statistic --mode random --probability <span class="m">0</span>.12500000000 -j KUBE-SEP-FM3234RRJZPD4GZX
-A KUBE-SVC-CUXC5A3HHHVSSN62 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -m statistic --mode random --probability <span class="m">0</span>.14286000002 -j KUBE-SEP-YOAWVANELGWJS5XG
-A KUBE-SVC-CUXC5A3HHHVSSN62 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -m statistic --mode random --probability <span class="m">0</span>.16667000018 -j KUBE-SEP-EV53L32GZTSBWT5L
-A KUBE-SVC-CUXC5A3HHHVSSN62 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -m statistic --mode random --probability <span class="m">0</span>.20000000019 -j KUBE-SEP-N7OVRTBYAU5DSTM3
-A KUBE-SVC-CUXC5A3HHHVSSN62 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -m statistic --mode random --probability <span class="m">0</span>.25000000000 -j KUBE-SEP-33XGFXWM5AKJXNJR
-A KUBE-SVC-CUXC5A3HHHVSSN62 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -m statistic --mode random --probability <span class="m">0</span>.33332999982 -j KUBE-SEP-CPH6I2HAHV4Y5PMM
-A KUBE-SVC-CUXC5A3HHHVSSN62 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -m statistic --mode random --probability <span class="m">0</span>.50000000000 -j KUBE-SEP-6ESI6K2EKT4JPG3E
-A KUBE-SVC-CUXC5A3HHHVSSN62 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -j KUBE-SEP-AOUKRORADL3ZFT3D</code></pre></div>
<p>50% 이상의 확률일 때는, <code>KUBE-SEP-AOUKRORADL3ZFT3D</code>에 점프하게 되는데, 패킷 소스가 <code>192.168.236.133/32</code>이면 Kubernetes 매스쿼레이딩을 하고, 그렇지 않은 tcp 패킷의 경우 <code>192.168.236.133:8080</code>로 전송됨을 알 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">-A KUBE-SEP-AOUKRORADL3ZFT3D -s <span class="m">192</span>.168.236.133/32 -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -j KUBE-MARK-MASQ
-A KUBE-SEP-AOUKRORADL3ZFT3D -p tcp -m comment --comment <span class="s2">&#34;default/kuard:&#34;</span> -m tcp -j DNAT --to-destination <span class="m">192</span>.168.236.133:8080</code></pre></div>
<p>실제로 마스터에 들어가서 ClusterIP에 대해 테스트해보면 다음과 같다. 요청마다 <code>HOSTNAME</code>의 값이 랜덤하게, 즉 서로 다른 호스트의 Pod이 랜덤으로 응답하고 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ubuntu@ip-10-0-18-181:~$ curl <span class="m">10</span>.110.41.209:80/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-nv89q&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl <span class="m">10</span>.110.41.209:80/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-bcsdh&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl <span class="m">10</span>.110.41.209:80/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-q7f2w&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl <span class="m">10</span>.110.41.209:80/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-nv89q&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl <span class="m">10</span>.110.41.209:80/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-f8sbq&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl <span class="m">10</span>.110.41.209:80/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-rsxrz&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl <span class="m">10</span>.110.41.209:80/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-bcsdh&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span></code></pre></div>
<h2 id="nodeport">NodePort</h2>

<p>그리고 <code>NodePort</code>의 값이 <code>30361</code>으로 할당되어 있다. 이 값은 동적으로 랜덤하게 설정된다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get svc kuard -o yaml
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: <span class="m">2019</span>-01-18T14:49:58Z
  labels:
    run: kuard
  name: kuard
  namespace: default
  resourceVersion: <span class="s2">&#34;15378&#34;</span>
  selfLink: /api/v1/namespaces/default/services/kuard
  uid: 53772d95-1b30-11e9-a27c-02b8e4b61ab8
spec:
  clusterIP: <span class="m">10</span>.110.41.209
  externalTrafficPolicy: Cluster
  ports:
  - nodePort: <span class="m">30361</span>
    port: <span class="m">80</span>
    protocol: TCP
    targetPort: <span class="m">8080</span>
  selector:
    run: kuard
  sessionAffinity: None
  type: LoadBalancer
status:
  loadBalancer:
    ingress:
    - hostname: a53772d951b3011e9a27c02b8e4b61ab-1700641417.ap-northeast-2.elb.amazonaws.com</code></pre></div>
<p><code>NodePort</code>는 Kubernetes 외부와 내부를 연결하는 브리지의 역할을 한다. 마스터 노드에 진입하여 해당 포트에 접속하면 <code>ClusterIP</code>와 동일하게 <code>HOSTNAME</code>의 값이 랜덤하게 변경되는 것을 알 수 있다. 즉, 모든 Kubernetes 노드에서 해당 NodePort <code>30361</code>을 통해 해당 서비스 <code>kuard</code>로 진입하게 된다.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ubuntu@ip-10-0-18-181:~$ curl localhost:30361/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-bcsdh&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl localhost:30361/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-q7f2w&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl localhost:30361/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-bgwrj&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl localhost:30361/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-cqxwq&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl localhost:30361/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-bgwrj&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span>
ubuntu@ip-10-0-18-181:~$ curl localhost:30361/env/api
<span class="o">{</span><span class="s2">&#34;commandLine&#34;</span>:<span class="o">[</span><span class="s2">&#34;/kuard&#34;</span><span class="o">]</span>,<span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/&#34;</span>,<span class="s2">&#34;HOSTNAME&#34;</span>:<span class="s2">&#34;kuard-dbdd7955d-qd9fj&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP&#34;</span>:<span class="s2">&#34;tcp://10.96.0.1:443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_ADDR&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_PORT_443_TCP_PROTO&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_HOST&#34;</span>:<span class="s2">&#34;10.96.0.1&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;KUBERNETES_SERVICE_PORT_HTTPS&#34;</span>:<span class="s2">&#34;443&#34;</span>,<span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span><span class="o">}}</span></code></pre></div>
<h2 id="loadbalancer">LoadBalancer</h2>

<p>마지막으로 앞서 보았던 <code>LoadBalancer</code> 타입의 서비스이다. 예제에서는 AWB의 ELB가 연결된다.</p>

<p>ELB의 리스너 항목을 살펴보면, 생성된 ELB의 로드 밸런서 포트는 <code>80</code>이고, EC2의 인스턴스 포트는 <code>30361</code>이다. 이 포트는 앞서 살펴본 Kubernetes에서 <code>kuard</code> Service의 <code>NodePort</code>의 값이다. 즉, ELB의 80으로 들어오는 모든 트래픽은 다음과 같이 EC2 인스턴스 중 하나로 전달되고, <code>30361</code>로 전달된 트래픽은 <code>kuard</code> Service에 의해 <code>kuard</code> Pod로 전달된다.</p>

<p><img src="../../tgik-002-loadbalaner.png" alt="" /></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ kubectl expose deployment kuard --type<span class="o">=</span>LoadBalancer --target-port<span class="o">=</span><span class="m">8080</span> --port<span class="o">=</span><span class="m">80</span>
service/kuard exposed

$ kubectl expose deployment kuard --type<span class="o">=</span>LoadBalancer --target-port<span class="o">=</span><span class="m">8080</span> --port<span class="o">=</span><span class="m">80</span> -o yaml
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: null
  labels:
    run: kuard
  name: kuard
spec:
  ports:
  - port: <span class="m">80</span>
    protocol: TCP
    targetPort: <span class="m">8080</span>
  selector:
    run: kuard
  type: LoadBalancer
status:
  loadBalancer: <span class="o">{}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>extensions/v1beta1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>annotations<span class="p">:</span><span class="w">
</span><span class="w">    </span>deployment.kubernetes.io/revision<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span><span class="w">  </span>creationTimestamp<span class="p">:</span><span class="w"> </span><span class="ld">2019-01-18T06:21:13Z</span><span class="w">
</span><span class="w">  </span>generation<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">  </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;1987&#34;</span><span class="w">
</span><span class="w">  </span>selfLink<span class="p">:</span><span class="w"> </span>/apis/extensions/v1beta1/namespaces/default/deployments/kuard<span class="w">
</span><span class="w">  </span>uid<span class="p">:</span><span class="w"> </span><span class="m">41075e21</span>-1ae9-<span class="m">11e9</span>-befa-0209e53cf850<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>progressDeadlineSeconds<span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">  </span>revisionHistoryLimit<span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>matchLabels<span class="p">:</span><span class="w">
</span><span class="w">      </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>strategy<span class="p">:</span><span class="w">
</span><span class="w">    </span>rollingUpdate<span class="p">:</span><span class="w">
</span><span class="w">      </span>maxSurge<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span>maxUnavailable<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">    </span>type<span class="p">:</span><span class="w"> </span>RollingUpdate<span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span>creationTimestamp<span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">
</span><span class="w">        </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>image<span class="p">:</span><span class="w"> </span>gcr.io/kuar-demo/kuard-amd64<span class="p">:</span><span class="m">1</span><span class="w">
</span><span class="w">        </span>imagePullPolicy<span class="p">:</span><span class="w"> </span>IfNotPresent<span class="w">
</span><span class="w">        </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">        </span>resources<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">        </span>terminationMessagePath<span class="p">:</span><span class="w"> </span>/dev/termination-log<span class="w">
</span><span class="w">        </span>terminationMessagePolicy<span class="p">:</span><span class="w"> </span>File<span class="w">
</span><span class="w">      </span>dnsPolicy<span class="p">:</span><span class="w"> </span>ClusterFirst<span class="w">
</span><span class="w">      </span>restartPolicy<span class="p">:</span><span class="w"> </span>Always<span class="w">
</span><span class="w">      </span>schedulerName<span class="p">:</span><span class="w"> </span>default-scheduler<span class="w">
</span><span class="w">      </span>securityContext<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">      </span>terminationGracePeriodSeconds<span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span><span class="w"></span>status<span class="p">:</span><span class="w">
</span><span class="w">  </span>availableReplicas<span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">  </span>conditions<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>lastTransitionTime<span class="p">:</span><span class="w"> </span><span class="ld">2019-01-18T06:21:22Z</span><span class="w">
</span><span class="w">    </span>lastUpdateTime<span class="p">:</span><span class="w"> </span><span class="ld">2019-01-18T06:21:22Z</span><span class="w">
</span><span class="w">    </span>message<span class="p">:</span><span class="w"> </span>Deployment<span class="w"> </span>has<span class="w"> </span>minimum<span class="w"> </span>availability.<span class="w">
</span><span class="w">    </span>reason<span class="p">:</span><span class="w"> </span>MinimumReplicasAvailable<span class="w">
</span><span class="w">    </span>status<span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span><span class="w">    </span>type<span class="p">:</span><span class="w"> </span>Available<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>lastTransitionTime<span class="p">:</span><span class="w"> </span><span class="ld">2019-01-18T06:21:13Z</span><span class="w">
</span><span class="w">    </span>lastUpdateTime<span class="p">:</span><span class="w"> </span><span class="ld">2019-01-18T06:21:23Z</span><span class="w">
</span><span class="w">    </span>message<span class="p">:</span><span class="w"> </span>ReplicaSet<span class="w"> </span><span class="s2">&#34;kuard-dbdd7955d&#34;</span><span class="w"> </span>has<span class="w"> </span>successfully<span class="w"> </span>progressed.<span class="w">
</span><span class="w">    </span>reason<span class="p">:</span><span class="w"> </span>NewReplicaSetAvailable<span class="w">
</span><span class="w">    </span>status<span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span><span class="w">    </span>type<span class="p">:</span><span class="w"> </span>Progressing<span class="w">
</span><span class="w">  </span>observedGeneration<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span>readyReplicas<span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">  </span>updatedReplicas<span class="p">:</span><span class="w"> </span><span class="m">10</span></code></pre></div>
<p><center>•••</center></p>

        
        <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/post/tgik-001/">TGI Kubernetes 001: A Quick Tour</a></li>
	
	<li><a href="/post/bastion-in-kops/">Kops에서 Bastion 호스트 SSH로 접속하기</a></li>
	
</ul>
</div>
        
      </div>
    </article>
    

    
    <nav class="post-nav">
        
        <a class="prev" href="/post/tgik-003/">
            &lt; <span class="prev-text nav-default">TGI Kubernetes 003: Istio</span>
                <span class="prev-text nav-mobile"></span>
        </a>
        
        <a class="next" href="/post/designing-scalable-portable-docker-container-networks/">
            <span class="next-text nav-default">[번역] 확장성 있고, 이식성 있는 도커 컨테이너 네트워크 설계</span>
            <span class="next-text nav-mobile"></span>
            >
        </a>
    </nav>

  </div>
 
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'ziwon';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p><a href="https://github.com/ziwon">Youngpil Yoon</a></p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129419926-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

