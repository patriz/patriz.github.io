<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>TGI Kubernetes 005: Pod Params and Probes | 人生は短くて使える時間も限られてる。</title>



<link href="https://ziwon.github.io/index.xml" rel="alternate" type="application/rss+xml" title="人生は短くて使える時間も限られてる。" />
<link rel='stylesheet' href='https://ziwon.github.io/css/style-kiss.css'><link rel='stylesheet' href='https://ziwon.github.io/css/custom.css'><link rel='stylesheet' href='https://ziwon.github.io/css/syntax-atom-one-dark.css'><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">


<link rel=“stylesheet” type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/hybrid.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/go.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/rust.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/scala.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://ziwon.github.io/">
          <h1 class="title is-4">人生は短くて使える時間も限られてる。</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="twitter" href='https://twitter.com/theluno'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="github" href='https://github.com/ziwon'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:yngpil.yoon@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="instagram" href='https://instagram.com/ziwon.y'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
    <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <article>
      <h1 class="title"><a href="https://ziwon.github.io/post/tgik-005/">TGI Kubernetes 005: Pod Params and Probes</a></h1>
      <h2 class="subtitle is-6">2019-02-11 </h2>
      <div class="subtitle tags is-6 is-pulled-right">
        
        
<a class="subtitle is-6" href="/tags/kubernetes">#Kubernetes</a>



  
  | <a class="subtitle is-6" href="/tags/probe">#probe</a>
  
  | <a class="subtitle is-6" href="/tags/tgik">#tgik</a>
  
  | <a class="subtitle is-6" href="/tags/readiness">#readiness</a>
  
  | <a class="subtitle is-6" href="/tags/liveness">#liveness</a>
  

        
      </div>
      <div class="content">
        

<blockquote>
<p>다섯 번 째 TGIK 에피소드는 특별한 내용이 없는 것 같네요. TGIK 진행된 분량이 많은 관계로 핵심만 추려서 빨리빨리 정리해야되지 않을까 싶네요.</p>
</blockquote>

<p><a href="https://github.com/heptio/tgik/tree/master/episodes/005" target="_blank">다섯 번 째 에피소드</a>는 Pod을 실행하는 모든 매개변수에 대해 설명한다. 구체적으로 readinessProbe, livenessProve,  restart 등 매개변수에 대해 설명한다.</p>

<p><code>kubectl run --help</code>는 스위스 군용 칼처럼 주어지는 매개변수에 따라 여러 가지 일을 한다. 사람들이 잘 모르는 한 가지 살펴볼만한 매개변수는 <a href="https://kubernetes.io/docs/reference/kubectl/conventions/#generators" target="_blank"><code>--generator</code></a>이다. <code>generator</code> 변수에 따라 여러가지 객체를 생성할 수 있다. 또한 다소 복잡해보이지만, <code>restart</code> 매개변수에 따라 생성되는 리소스가 달라진다.</p>

<table>
<thead>
<tr>
<th>Generated<br/> Resource</th>
<th>Cluster v1.4과 그 이후</th>
<th>Cluster v1.3</th>
<th>Cluster v1.2</th>
<th>Cluster v1.1 그 이전</th>
</tr>
</thead>

<tbody>
<tr>
<td>Pod</td>
<td><code>--restart=Never</code></td>
<td><code>--restart=Never</code></td>
<td><code>--generator=run-pod/v1</code></td>
<td><code>--restart=OnFailure</code> 또는 <code>--restart=Never</code></td>
</tr>

<tr>
<td>Replication<br/>Controller</td>
<td><code>--generator=run/v1</code></td>
<td><code>--generator=run/v1</code></td>
<td><code>--generator=run/v1</code></td>
<td><code>--restart=Always</code></td>
</tr>

<tr>
<td>Deployment</td>
<td><code>--restart=Always</code></td>
<td><code>--restart=Always</code></td>
<td><code>--restart=Always</code></td>
<td>N/A</td>
</tr>

<tr>
<td>Job</td>
<td><code>--restart=OnFailure</code></td>
<td><code>--restart=OnFailure</code></td>
<td><code>--restart=OnFailure</code> OR <code>--restart=Never</code></td>
<td>N/A</td>
</tr>

<tr>
<td>Cron Job</td>
<td><code>--schedule=&lt;cron&gt;</code></td>
<td>N/A</td>
<td>N/A</td>
<td>N/A</td>
</tr>
</tbody>
</table>

<h2 id="쿠버네티스-오브젝트를-yaml파일로-추출하는-방법">쿠버네티스 오브젝트를 yaml파일로 추출하는 방법</h2>

<p>kubectl 에 많은 옵션들이 있지만, 원하는 모든 것들을 kubectl로 할 수 있는 것은 아니다. Pop을 설정하는 다양한 값들을 커맨드 라인에 구겨넣는 게 쉽지 않은 일이며 kubectl은 제한된 뷰만을 보여줄 뿐이다.</p>

<p>실행 중인 Pod이 있고, 모킹을 해서 뭔가 다른 작업을 하고 싶을 경우 명령적인 모드에서 Pop을 실행하고 선억적인 모드로 전환하여 구체적인 다른 작업을 설정할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">kubectl get po kuard -o yaml &gt; kurad.yaml</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>creationTimestamp<span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-02-11T06:43:45Z&#34;</span><span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>namespace<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">  </span>resourceVersion<span class="p">:</span><span class="w"> </span><span class="s2">&#34;4582&#34;</span><span class="w">
</span><span class="w">  </span>selfLink<span class="p">:</span><span class="w"> </span>/api/v1/namespaces/default/pods/kuard<span class="w">
</span><span class="w">  </span>uid<span class="p">:</span><span class="w"> </span>60b510d5-2dc8-<span class="m">11e9</span>-<span class="m">82e8</span>-0242cfd2ed41<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>containers<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>image<span class="p">:</span><span class="w"> </span>gcr.io/kuar-demo/kuard-amd64<span class="p">:</span>blue<span class="w">
</span><span class="w">    </span>imagePullPolicy<span class="p">:</span><span class="w"> </span>IfNotPresent<span class="w">
</span><span class="w">    </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">    </span>resources<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">    </span>terminationMessagePath<span class="p">:</span><span class="w"> </span>/dev/termination-log<span class="w">
</span><span class="w">    </span>terminationMessagePolicy<span class="p">:</span><span class="w"> </span>File<span class="w">
</span><span class="w">    </span>volumeMounts<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>mountPath<span class="p">:</span><span class="w"> </span>/var/run/secrets/kubernetes.io/serviceaccount<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>default-token-g95gt<span class="w">
</span><span class="w">      </span>readOnly<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>dnsPolicy<span class="p">:</span><span class="w"> </span>ClusterFirst<span class="w">
</span><span class="w">  </span>enableServiceLinks<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>nodeName<span class="p">:</span><span class="w"> </span>kind-<span class="m">1</span>-worker2<span class="w">
</span><span class="w">  </span>priority<span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="w">  </span>restartPolicy<span class="p">:</span><span class="w"> </span>Never<span class="w">
</span><span class="w">  </span>schedulerName<span class="p">:</span><span class="w"> </span>default-scheduler<span class="w">
</span><span class="w">  </span>securityContext<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">  </span>serviceAccount<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">  </span>serviceAccountName<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">  </span>terminationGracePeriodSeconds<span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span><span class="w">  </span>tolerations<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>effect<span class="p">:</span><span class="w"> </span>NoExecute<span class="w">
</span><span class="w">    </span>key<span class="p">:</span><span class="w"> </span>node.kubernetes.io/not-ready<span class="w">
</span><span class="w">    </span>operator<span class="p">:</span><span class="w"> </span>Exists<span class="w">
</span><span class="w">    </span>tolerationSeconds<span class="p">:</span><span class="w"> </span><span class="m">300</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>effect<span class="p">:</span><span class="w"> </span>NoExecute<span class="w">
</span><span class="w">    </span>key<span class="p">:</span><span class="w"> </span>node.kubernetes.io/unreachable<span class="w">
</span><span class="w">    </span>operator<span class="p">:</span><span class="w"> </span>Exists<span class="w">
</span><span class="w">    </span>tolerationSeconds<span class="p">:</span><span class="w"> </span><span class="m">300</span><span class="w">
</span><span class="w">  </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>default-token-g95gt<span class="w">
</span><span class="w">    </span>secret<span class="p">:</span><span class="w">
</span><span class="w">      </span>defaultMode<span class="p">:</span><span class="w"> </span><span class="m">420</span><span class="w">
</span><span class="w">      </span>secretName<span class="p">:</span><span class="w"> </span>default-token-g95gt<span class="w">
</span><span class="w"></span>status<span class="p">:</span><span class="w">
</span><span class="w">  </span>conditions<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>lastProbeTime<span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">    </span>lastTransitionTime<span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-02-11T06:43:45Z&#34;</span><span class="w">
</span><span class="w">    </span>status<span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span><span class="w">    </span>type<span class="p">:</span><span class="w"> </span>Initialized<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>lastProbeTime<span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">    </span>lastTransitionTime<span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-02-11T06:43:52Z&#34;</span><span class="w">
</span><span class="w">    </span>status<span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span><span class="w">    </span>type<span class="p">:</span><span class="w"> </span>Ready<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>lastProbeTime<span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">    </span>lastTransitionTime<span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-02-11T06:43:52Z&#34;</span><span class="w">
</span><span class="w">    </span>status<span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span><span class="w">    </span>type<span class="p">:</span><span class="w"> </span>ContainersReady<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>lastProbeTime<span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">    </span>lastTransitionTime<span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-02-11T06:43:45Z&#34;</span><span class="w">
</span><span class="w">    </span>status<span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span><span class="w">    </span>type<span class="p">:</span><span class="w"> </span>PodScheduled<span class="w">
</span><span class="w">  </span>containerStatuses<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>containerID<span class="p">:</span><span class="w"> </span>docker<span class="p">:</span>//74ff093a0684537893e20c67d789142c68fa2c8d1ead84909e9aec2c4d7d0985<span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>gcr.io/kuar-demo/kuard-amd64<span class="p">:</span>blue<span class="w">
</span><span class="w">    </span>imageID<span class="p">:</span><span class="w"> </span>docker-pullable<span class="p">:</span>//gcr.io/kuar-demo/kuard-amd64@sha256<span class="p">:</span>c9996fc6b5c26d537e47dffd1b9a724682721883bfc9340d5cf94767ba76f103<span class="w">
</span><span class="w">    </span>lastState<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">    </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">    </span>ready<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span>restartCount<span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="w">    </span>state<span class="p">:</span><span class="w">
</span><span class="w">      </span>running<span class="p">:</span><span class="w">
</span><span class="w">        </span>startedAt<span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-02-11T06:43:51Z&#34;</span><span class="w">
</span><span class="w">  </span>hostIP<span class="p">:</span><span class="w"> </span><span class="m">172.17</span>.<span class="m">0.6</span><span class="w">
</span><span class="w">  </span>phase<span class="p">:</span><span class="w"> </span>Running<span class="w">
</span><span class="w">  </span>podIP<span class="p">:</span><span class="w"> </span><span class="m">10.42</span>.<span class="m">0.1</span><span class="w">
</span><span class="w">  </span>qosClass<span class="p">:</span><span class="w"> </span>BestEffort<span class="w">
</span><span class="w">  </span>startTime<span class="p">:</span><span class="w"> </span><span class="s2">&#34;2019-02-11T06:43:45Z&#34;</span></code></pre></div>
<p>위 파일을 편집기로 열면 보게 되는 것 중에 하나가 <code>resourceVersion</code>이다. 이는 리소스를 변경할 때 기준이 되는 특정 리소스의 버전이다. 이를 기본 Yaml 파일을 사용해서 Pod을 실행하고자 한다면 동작하지 않는다.</p>

<p>그래서 다음과 같이 <code>--export</code> 옵션을 사용하면 서버가 추가한 모든 것들을 제거해낼 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">kubectl get po kuard -o yaml --export &gt; kuard.yaml</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>annotations<span class="p">:</span><span class="w">
</span><span class="w">    </span>kubectl.kubernetes.io/last-applied-configuration<span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">      {&#34;apiVersion&#34;:&#34;v1&#34;,&#34;kind&#34;:&#34;Pod&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;creationTimestamp&#34;:&#34;2019-02-11T06:43:45Z&#34;,&#34;labels&#34;:{&#34;run&#34;:&#34;kuard&#34;},&#34;name&#34;:&#34;kuard&#34;,&#34;namespace&#34;:&#34;default&#34;,&#34;resourceVersion&#34;:&#34;4582&#34;,&#34;selfLink&#34;:&#34;/api/v1/namespaces/default/pods/kuard&#34;,&#34;uid&#34;:&#34;60b510d5-2dc8-11e9-82e8-0242cfd2ed41&#34;},&#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;gcr.io/kuar-demo/kuard-amd64:blue&#34;,&#34;imagePullPolicy&#34;:&#34;IfNotPresent&#34;,&#34;name&#34;:&#34;kuard&#34;,&#34;resources&#34;:{},&#34;terminationMessagePath&#34;:&#34;/dev/termination-log&#34;,&#34;terminationMessagePolicy&#34;:&#34;File&#34;,&#34;volumeMounts&#34;:[{&#34;mountPath&#34;:&#34;/var/run/secrets/kubernetes.io/serviceaccount&#34;,&#34;name&#34;:&#34;default-token-g95gt&#34;,&#34;readOnly&#34;:true}]}],&#34;dnsPolicy&#34;:&#34;ClusterFirst&#34;,&#34;enableServiceLinks&#34;:true,&#34;nodeName&#34;:&#34;kind-1-worker2&#34;,&#34;priority&#34;:0,&#34;restartPolicy&#34;:&#34;Never&#34;,&#34;schedulerName&#34;:&#34;default-scheduler&#34;,&#34;securityContext&#34;:{},&#34;serviceAccount&#34;:&#34;default&#34;,&#34;serviceAccountName&#34;:&#34;default&#34;,&#34;terminationGracePeriodSeconds&#34;:30,&#34;tolerations&#34;:[{&#34;effect&#34;:&#34;NoExecute&#34;,&#34;key&#34;:&#34;node.kubernetes.io/not-ready&#34;,&#34;operator&#34;:&#34;Exists&#34;,&#34;tolerationSeconds&#34;:300},{&#34;effect&#34;:&#34;NoExecute&#34;,&#34;key&#34;:&#34;node.kubernetes.io/unreachable&#34;,&#34;operator&#34;:&#34;Exists&#34;,&#34;tolerationSeconds&#34;:300}],&#34;volumes&#34;:[{&#34;name&#34;:&#34;default-token-g95gt&#34;,&#34;secret&#34;:{&#34;defaultMode&#34;:420,&#34;secretName&#34;:&#34;default-token-g95gt&#34;}}]},&#34;status&#34;:{&#34;conditions&#34;:[{&#34;lastProbeTime&#34;:null,&#34;lastTransitionTime&#34;:&#34;2019-02-11T06:43:45Z&#34;,&#34;status&#34;:&#34;True&#34;,&#34;type&#34;:&#34;Initialized&#34;},{&#34;lastProbeTime&#34;:null,&#34;lastTransitionTime&#34;:&#34;2019-02-11T06:43:52Z&#34;,&#34;status&#34;:&#34;True&#34;,&#34;type&#34;:&#34;Ready&#34;},{&#34;lastProbeTime&#34;:null,&#34;lastTransitionTime&#34;:&#34;2019-02-11T06:43:52Z&#34;,&#34;status&#34;:&#34;True&#34;,&#34;type&#34;:&#34;ContainersReady&#34;},{&#34;lastProbeTime&#34;:null,&#34;lastTransitionTime&#34;:&#34;2019-02-11T06:43:45Z&#34;,&#34;status&#34;:&#34;True&#34;,&#34;type&#34;:&#34;PodScheduled&#34;}],&#34;containerStatuses&#34;:[{&#34;containerID&#34;:&#34;docker://74ff093a0684537893e20c67d789142c68fa2c8d1ead84909e9aec2c4d7d0985&#34;,&#34;image&#34;:&#34;gcr.io/kuar-demo/kuard-amd64:blue&#34;,&#34;imageID&#34;:&#34;docker-pullable://gcr.io/kuar-demo/kuard-amd64@sha256:c9996fc6b5c26d537e47dffd1b9a724682721883bfc9340d5cf94767ba76f103&#34;,&#34;lastState&#34;:{},&#34;name&#34;:&#34;kuard&#34;,&#34;ready&#34;:true,&#34;restartCount&#34;:0,&#34;state&#34;:{&#34;running&#34;:{&#34;startedAt&#34;:&#34;2019-02-11T06:43:51Z&#34;}}}],&#34;hostIP&#34;:&#34;172.17.0.6&#34;,&#34;phase&#34;:&#34;Running&#34;,&#34;podIP&#34;:&#34;10.42.0.1&#34;,&#34;qosClass&#34;:&#34;BestEffort&#34;,&#34;startTime&#34;:&#34;2019-02-11T06:43:45Z&#34;}}</span><span class="w">
</span><span class="w">  </span>creationTimestamp<span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>selfLink<span class="p">:</span><span class="w"> </span>/api/v1/namespaces/default/pods/kuard<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>containers<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>image<span class="p">:</span><span class="w"> </span>gcr.io/kuar-demo/kuard-amd64<span class="p">:</span>blue<span class="w">
</span><span class="w">    </span>imagePullPolicy<span class="p">:</span><span class="w"> </span>IfNotPresent<span class="w">
</span><span class="w">    </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">    </span>resources<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">    </span>terminationMessagePath<span class="p">:</span><span class="w"> </span>/dev/termination-log<span class="w">
</span><span class="w">    </span>terminationMessagePolicy<span class="p">:</span><span class="w"> </span>File<span class="w">
</span><span class="w">    </span>volumeMounts<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>mountPath<span class="p">:</span><span class="w"> </span>/var/run/secrets/kubernetes.io/serviceaccount<span class="w">
</span><span class="w">      </span>name<span class="p">:</span><span class="w"> </span>default-token-g95gt<span class="w">
</span><span class="w">      </span>readOnly<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>dnsPolicy<span class="p">:</span><span class="w"> </span>ClusterFirst<span class="w">
</span><span class="w">  </span>enableServiceLinks<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>nodeName<span class="p">:</span><span class="w"> </span>kind-<span class="m">1</span>-worker3<span class="w">
</span><span class="w">  </span>priority<span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="w">  </span>restartPolicy<span class="p">:</span><span class="w"> </span>Never<span class="w">
</span><span class="w">  </span>schedulerName<span class="p">:</span><span class="w"> </span>default-scheduler<span class="w">
</span><span class="w">  </span>securityContext<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">  </span>serviceAccount<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">  </span>serviceAccountName<span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">  </span>terminationGracePeriodSeconds<span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span><span class="w">  </span>tolerations<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>effect<span class="p">:</span><span class="w"> </span>NoExecute<span class="w">
</span><span class="w">    </span>key<span class="p">:</span><span class="w"> </span>node.kubernetes.io/not-ready<span class="w">
</span><span class="w">    </span>operator<span class="p">:</span><span class="w"> </span>Exists<span class="w">
</span><span class="w">    </span>tolerationSeconds<span class="p">:</span><span class="w"> </span><span class="m">300</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>effect<span class="p">:</span><span class="w"> </span>NoExecute<span class="w">
</span><span class="w">    </span>key<span class="p">:</span><span class="w"> </span>node.kubernetes.io/unreachable<span class="w">
</span><span class="w">    </span>operator<span class="p">:</span><span class="w"> </span>Exists<span class="w">
</span><span class="w">    </span>tolerationSeconds<span class="p">:</span><span class="w"> </span><span class="m">300</span><span class="w">
</span><span class="w">  </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>default-token-g95gt<span class="w">
</span><span class="w">    </span>secret<span class="p">:</span><span class="w">
</span><span class="w">      </span>defaultMode<span class="p">:</span><span class="w"> </span><span class="m">420</span><span class="w">
</span><span class="w">      </span>secretName<span class="p">:</span><span class="w"> </span>default-token-g95gt<span class="w">
</span><span class="w"></span>status<span class="p">:</span><span class="w">
</span><span class="w">  </span>phase<span class="p">:</span><span class="w"> </span>Pending<span class="w">
</span><span class="w">  </span>qosClass<span class="p">:</span><span class="w"> </span>BestEffort</code></pre></div>
<p>그러나 Pod의 표준적인 정의(canonical definition) 등 제거해야할 요소가 여전히 있다. 선언적 방식으로 Pod를 배포하는데에 사용할 수는 있지만, 처음부터 선언적 방식으로 하고자 한다면 다음과 같이 <code>--dry-run</code> 옵션을 사용한다.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">kubectl run --generator<span class="o">=</span>run-pod/v1 --image<span class="o">=</span>gcr.io/kuar-demo/kuard-amd64:blue kuard -o yaml --dry-run &gt; kuard.yaml</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>creationTimestamp<span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>containers<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>image<span class="p">:</span><span class="w"> </span>gcr.io/kuar-demo/kuard-amd64<span class="p">:</span>blue<span class="w">
</span><span class="w">    </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">    </span>resources<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">  </span>dnsPolicy<span class="p">:</span><span class="w"> </span>ClusterFirst<span class="w">
</span><span class="w">  </span>restartPolicy<span class="p">:</span><span class="w"> </span>Always<span class="w">
</span><span class="w"></span>status<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w"></span>}</code></pre></div>
<p>여기서 살펴볼 것은 <code>restartPolicy</code>이다. 데모에서는 우분투 노드에 접속하여 docker를 죽여도 restartPolicy에 의해 Pod이 재시작되는 것을 보여준다. 다음으로 노드를 삭제(AWS에서는 Terminated) 시켰을 때, 즉 clean shutdown 시켰을 때, AWS 오토스케일링 그룹에 의해 새로운 노드가 부팅이 되지만, Pod은 사라진다. 그러나 <code>ReplicaSet</code>으로 선언하면 노드가 사라져도 다른 노드에서 새로 만든다. 보통 이를 Rescheduling이라고 알고 있는데, 실제로는 다른 노드에서 다른 이름으로 새로 생성하는 Recreating이라고 한다.</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>ReplicaSet<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>matchLabels<span class="p">:</span><span class="w">
</span><span class="w">      </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">
</span><span class="w">        </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>image<span class="p">:</span><span class="w"> </span>gcr.io/kuar-demo/kuard-amd64<span class="p">:</span>blue<span class="w">
</span><span class="w">        </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">        </span>resources<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">      </span>dnsPolicy<span class="p">:</span><span class="w"> </span>ClusterFirst<span class="w">
</span><span class="w">      </span>restartPolicy<span class="p">:</span><span class="w"> </span>Never</code></pre></div>
<p>참고로, Joe Beda님은 동의를 못하겠다고 하지만 ReplicaSet의 경우 다음과 같이 restartPolicy가 Never로 설정이 되지 않는다.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">The ReplicaSet <span class="s2">&#34;kuard&#34;</span> is invalid: spec.template.spec.restartPolicy: Unsupported value: <span class="s2">&#34;Never&#34;</span>: supported values: <span class="s2">&#34;Always&#34;</span></code></pre></div>
<h2 id="probe">Probe</h2>

<p>이제 Probe에 대해 설명한다. 가장 미니멀한 Deployment는 다음 명령으로 생성할 수 있다.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl run  --image<span class="o">=</span>gcr.io/kuar-demo/kuard-amd64:blue kuard -o yaml --dry-run &gt; kuard.yaml</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>apps/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>creationTimestamp<span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">  </span>labels<span class="p">:</span><span class="w">
</span><span class="w">    </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>matchLabels<span class="p">:</span><span class="w">
</span><span class="w">      </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">  </span>strategy<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span>creationTimestamp<span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">
</span><span class="w">        </span>run<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>image<span class="p">:</span><span class="w"> </span>gcr.io/kuar-demo/kuard-amd64<span class="p">:</span>blue<span class="w">
</span><span class="w">        </span>name<span class="p">:</span><span class="w"> </span>kuard<span class="w">
</span><span class="w">        </span>resources<span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w"></span>status<span class="p">:</span><span class="w"> </span>{}</code></pre></div>
<p>위에서 <code>replicas</code>의 값을 5로 설정하였는데, Deployment는 ReplicaSet를 생성하고, ReplicaSet은 Pod을 생성한다. 알다시피, Probe에는 두 가지가 있는데, Readiness Probe는 트래픽을 받을 준비가 된 것이고, Liveness Probe는 서버가 정상적인지  기술힌다. 서버가 초기화 중이거나 또는 셧다운 중일 때는 Live이지만, Ready가 아닌 상태가 될 수 있다. Liveness Probe가 깨지면 그 Pod은 재시작된다. (예를 들어, 디비 커넥션 풀이 한도가 차서 서버에 더 이상 접속이 되지 않는 초보적인 오류의 경우, 해당 서버에 접속하여 수동으로 재시작하곤 하는데, Kubernetes에서는 자동으로 재시작되게 할 수 있다.) 그리고 Service에서 Readiness Probe에서 실패가 되고 있는 Pod들은 Endpoint 집합에서 축출하게 된다. 질문에서 잠깐 언급된 것처럼 Readiness Probe 상태가 실패인 것들을 오토스케일링 그룹 관점에서 축출하는 용도로는 사용하지 않는다고 한다.</p>

<p>다음은 Probe 설정에 관한 몇 가지 필드들이다.</p>

<ul>
<li><code>initialDelaySeconds</code>: liveness 또는 readiness 상태 프로브가 시작되기 전에 컨테이너가 시작된 후의 시간 (초)</li>
<li><code>periodSeconds</code>: 프로브 수행 빈도 (초). 기본값은 10초. 최소값은 1초</li>
<li><code>timeoutSeconds</code>: 프로브가 초과되는 시간 (초). 기본값은 1초. 최소값은 1초</li>
<li><code>successThreshod</code>: 실패 후 프로브가 성공한 것으로 간주되는 프로브의 최소 연속적인 성공 횟수. 기본값은 1. liveness는 1이어야 함. 최소값은 1.</li>
<li><code>failureThreshold</code>: Pod가 시작되고 프로브가 실패하면, 쿠버네티스는 failureThreshold 횟수 동안 실패를 시도한다. liveness 프로브의 경우, 포기는 포드를 다시 시작하는 것을 의미. 준비 상태 검사의 경우 포드는 Unready로 표시.<br /></li>
</ul>

<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#httpgetaction-v1-core" target="_blank">HTTP probes</a>에는 추가적인 필드가 있다.</p>

<ul>
<li><code>host</code>: 연결할 호스트 이름. 기본적으로 포드 IP로 설정.</li>
<li><code>scheme</code>: 호스트 연결에 사용할 스킴. 기본값은 HTTP</li>
<li><code>path</code>: HTTP 서버에 액세스하기 위한 경로</li>
<li><code>httpHeaders</code>: 요청에 설정할 사용자 지정 헤더. HTTP는 반복 헤더를 사용할 수 있음.</li>
<li><code>port</code>: 컨테이너에 억세스하는 포트의 번호 또는 이름. 1 ~ 65535 사이의 값</li>
</ul>

        
        <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/post/tgik-004/">TGI Kubernetes 004: RBAC</a></li>
	
	<li><a href="/post/tgik-003/">TGI Kubernetes 003: Istio</a></li>
	
	<li><a href="/post/tgik-002/">TGI Kubernetes 002: Networking and Services</a></li>
	
	<li><a href="/post/tgik-001/">TGI Kubernetes 001: A Quick Tour</a></li>
	
	<li><a href="/post/bastion-in-kops/">Kops에서 Bastion 호스트 SSH로 접속하기</a></li>
	
</ul>
</div>
        
      </div>
    </article>
    

    
    <nav class="post-nav">
        
        <a class="prev" href="/post/docker-storage-overview/">
            &lt; <span class="prev-text nav-default">[번역] 도커 스토리지 소개</span>
                <span class="prev-text nav-mobile"></span>
        </a>
        
        <a class="next" href="/post/tgik-004/">
            <span class="next-text nav-default">TGI Kubernetes 004: RBAC</span>
            <span class="next-text nav-mobile"></span>
            >
        </a>
    </nav>

  </div>
 
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'ziwon';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p><a href="https://github.com/ziwon">Youngpil Yoon</a></p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129419926-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

