<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Using custom model_to_dict() in Django | 人生は儚く短い。</title>



<link href="https://ziwon.github.io/index.xml" rel="alternate" type="application/rss+xml" title="人生は儚く短い。" />

<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='https://ziwon.github.io/css/custom.css'><link rel='stylesheet' href='https://ziwon.github.io/css/syntax.css'><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<link rel=“stylesheet” type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/hybrid.min.css"/>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/go.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/rust.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/scala.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://ziwon.github.io/">
          <h1 class="title is-4">人生は儚く短い。</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="twitter" href='https://twitter.com/theluno'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="github" href='https://github.com/ziwon'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:yngpil.yoon@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="instagram" href='https://instagram.com/ziwon.y'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
    <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/python">#python</a>



  
  | <a class="subtitle is-6" href="/tags/django">#django</a>
  

      
    </div>
    <h2 class="subtitle is-6">December 9, 2016</h2>
    <h1 class="title">Using custom model_to_dict() in Django</h1>
    
    <div class="content">
      <p>In Django, when converting a database model to a dictionary, I usually used to convert only the member variables corresponding to the column of the table to handle the response to the request in the form of Json and so on. But, whenever you encounter a member variable of type <code>ManyToManyField</code>, it would be too cumbersome to write three or four lines of code each time to loop around to get their values from the member variables of the <code>ManyToManyField</code> in a model object.</p>

<p>For example, suppose you have a modeling class of <code>Publication</code>, <code>Article</code> as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> django.db <span style="color:#f92672">import</span> models

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Publication</span>(models<span style="color:#f92672">.</span>Model):
    title <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)

    <span style="color:#66d9ef">def</span> __str__(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>title

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Meta</span>:
        ordering <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;title&#39;</span>,)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Article</span>(models<span style="color:#f92672">.</span>Model):
    headline <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>)
    publications <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ManyToManyField(Publication)

    <span style="color:#66d9ef">def</span> __str__(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>headline

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Meta</span>:
        ordering <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;headline&#39;</span>,)</code></pre></div>
<p>For the <code>Publication</code> instance, you can convert it to a dictionary by calling the <code>model_to_dict()</code> function only once. However, when converting an instance of <code>Article</code> with a member variable of <code>ManyToManyField</code> to a dictionary, you have to invoke <code>model_to_dict()</code> or loop around more than once to get their values because <code>ManyToManyField</code> is a list type.</p>

<p>Whenever I encountered <code>ManyToManyField</code>, I used to create a separate method, or loop it, and convert it each by each. Suddenly, every time I write a for statement or a separate function, I thought it would be better to solve it all once.</p>

<p>For example, let&rsquo;s say you have a property in the <code>Article</code> class, a member function, and several <code>ManyToManyField</code>s like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Article</span>(models<span style="color:#f92672">.</span>Model):
    headline <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>CharField(max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>)
    publications <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ManyToManyField(Publication)
    tags <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>ManyToManyField(Tag)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">convert_cover_img</span>(self):
        <span style="color:#f92672">...</span>

    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">count</span>(self):
        <span style="color:#f92672">...</span>

    <span style="color:#66d9ef">def</span> __str__(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>headline

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Meta</span>:
        ordering <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;headline&#39;</span>,)</code></pre></div>
<p>What I want is to specify each values to be transformed, it could be such as member variables, member functions, and properties of the modeling class, as shown below, and the whole instance is converted into a single dictationary chunk in a single call. For example, if you need only one of the member variables of <code>ManyToManyField</code>, you can convert it to <code>__[field_name]</code> by specifying the desired field name as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">FIELDS <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;id&#39;</span>, <span style="color:#e6db74">&#39;headline&#39;</span>, <span style="color:#e6db74">&#39;publications__title&#39;</span>, <span style="color:#e6db74">&#39;tags__name&#39;</span>, <span style="color:#e6db74">&#39;convert_cover_img&#39;</span>, <span style="color:#e6db74">&#39;count&#39;</span>]
result <span style="color:#f92672">=</span> OrderedDict()
result[<span style="color:#e6db74">&#39;data&#39;</span>] <span style="color:#f92672">=</span> [model_to_dict(instance<span style="color:#f92672">=</span>obj, fields<span style="color:#f92672">=</span>FIELDS) <span style="color:#66d9ef">for</span> obj <span style="color:#f92672">in</span> page<span style="color:#f92672">.</span>object_list]
result[<span style="color:#e6db74">&#39;has_next&#39;</span>] <span style="color:#f92672">=</span> page<span style="color:#f92672">.</span>has_next()
<span style="color:#f92672">...</span>
<span style="color:#66d9ef">return</span> JsonResponse(format_response(result, RES_OK))</code></pre></div>
<p>Unfortunately, if you need more than one column for <code>ManyToManyField</code> to build the response like json form, you have no choice but to define a seperate property or function in a model class. In a specific case, for example, if you are extending all attributes - like id, name and etc - of the tags member variable ManyToManyField while converting the Article instance.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@property</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">tags_to_dict</span>(self):
    <span style="color:#f92672">...</span></code></pre></div>
<p>However, since the model class describes the process of transforming their member variables, the above manner has the advantage that it is well modularized and reusable. As a result, the entire code is really simple and neat, because it can hide the process of converting an instance to a dictionary.</p>

<p>Now we no longer have to loop around to handle <code>ManyToManyFields</code> or write a separate function. It also eliminates the need to worry about member properties or member functions, which is not modeling fields .</p>

<p>Here is the code for <code>model_to_dict()</code> that was created. Once the conversion code of the a model is unified into just one line as shown below, repetitive and annoying coding for conversion is no longer needed. Since the parent class is created and the most job in the inherited child class is just to specify only the fields to be converted. As a result, the development speed can be much faster, which can improve the quality of the query set manager or focus on more creative work.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">model_to_dict</span>(instance, fields<span style="color:#f92672">=</span>None, exclude<span style="color:#f92672">=</span>None, date_to_strf<span style="color:#f92672">=</span>None):
    <span style="color:#f92672">from</span> django.db.models.fields.related <span style="color:#f92672">import</span> ManyToManyField
    <span style="color:#f92672">from</span> django.db.models.fields <span style="color:#f92672">import</span> DateTimeField
    <span style="color:#f92672">from</span> django.db.models.fields.files <span style="color:#f92672">import</span> ImageField, FileField
    opts <span style="color:#f92672">=</span> instance<span style="color:#f92672">.</span>_meta
    data <span style="color:#f92672">=</span> {}

    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Why is `__fields` in here?
</span><span style="color:#e6db74">        it holds the list of fields except for the one ends with a suffix &#39;__[field_name]&#39;.
</span><span style="color:#e6db74">        When converting a model object to a dictionary using this method,
</span><span style="color:#e6db74">        You can use a suffix to point to the field of ManyToManyField in the model instance.
</span><span style="color:#e6db74">        The suffix ends with &#39;__[field_name]&#39; like &#39;publications__name&#39;
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    __fields <span style="color:#f92672">=</span> list(map(<span style="color:#66d9ef">lambda</span> a: a<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;__&#39;</span>)[<span style="color:#ae81ff">0</span>], fields <span style="color:#f92672">or</span> []))

    <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> chain(opts<span style="color:#f92672">.</span>concrete_fields, opts<span style="color:#f92672">.</span>virtual_fields, opts<span style="color:#f92672">.</span>many_to_many):
        is_edtiable <span style="color:#f92672">=</span> getattr(f, <span style="color:#e6db74">&#39;editable&#39;</span>, False)

        <span style="color:#66d9ef">if</span> fields <span style="color:#f92672">and</span> f<span style="color:#f92672">.</span>name <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> __fields:
            <span style="color:#66d9ef">continue</span>

        <span style="color:#66d9ef">if</span> exclude <span style="color:#f92672">and</span> f<span style="color:#f92672">.</span>name <span style="color:#f92672">in</span> exclude:
            <span style="color:#66d9ef">continue</span>

        <span style="color:#66d9ef">if</span> isinstance(f, ManyToManyField):
            <span style="color:#66d9ef">if</span> instance<span style="color:#f92672">.</span>pk <span style="color:#f92672">is</span> None:
                data[f<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> []
            <span style="color:#66d9ef">else</span>:
                qs <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>value_from_object(instance)
                <span style="color:#66d9ef">if</span> qs<span style="color:#f92672">.</span>_result_cache <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
                    data[f<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> [item<span style="color:#f92672">.</span>pk <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> qs]
                <span style="color:#66d9ef">else</span>:
                    <span style="color:#66d9ef">try</span>:
                        m2m_field  <span style="color:#f92672">=</span> list(filter(<span style="color:#66d9ef">lambda</span> a: f<span style="color:#f92672">.</span>name <span style="color:#f92672">in</span> a <span style="color:#f92672">and</span> a<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#39;__&#39;</span>) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, fields))[<span style="color:#ae81ff">0</span>]
                        key <span style="color:#f92672">=</span> m2m_field[len(f<span style="color:#f92672">.</span>name) <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>:]
                        data[f<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> list(qs<span style="color:#f92672">.</span>values_list(key, flat<span style="color:#f92672">=</span>True))
                    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">IndexError</span>:
                        data[f<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> list(qs<span style="color:#f92672">.</span>values_list(<span style="color:#e6db74">&#39;pk&#39;</span>, flat<span style="color:#f92672">=</span>True))

        <span style="color:#66d9ef">elif</span> isinstance(f, DateTimeField):
            date <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>value_from_object(instance)
            data[f<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> date_to_strf(date) <span style="color:#66d9ef">if</span> date_to_strf <span style="color:#66d9ef">else</span> date_to_timestamp(date)

        <span style="color:#66d9ef">elif</span> isinstance(f, ImageField):
            image <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>value_from_object(instance)
            data[f<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> image<span style="color:#f92672">.</span>url <span style="color:#66d9ef">if</span> image <span style="color:#66d9ef">else</span> None

        <span style="color:#66d9ef">elif</span> isinstance(f, FileField):
            file <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>value_from_object(instance)
            data[f<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> file<span style="color:#f92672">.</span>url <span style="color:#66d9ef">if</span> file  <span style="color:#66d9ef">else</span> None

        <span style="color:#66d9ef">elif</span> is_edtiable:
            data[f<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>value_from_object(instance)

    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Just call an instance&#39;s function or property from a string with the function name in `__fields` arguments.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    funcs <span style="color:#f92672">=</span> set(__fields) <span style="color:#f92672">-</span> set(list(data<span style="color:#f92672">.</span>keys()))
    <span style="color:#66d9ef">for</span> func <span style="color:#f92672">in</span> funcs:
        obj <span style="color:#f92672">=</span> getattr(instance, func)
        <span style="color:#66d9ef">if</span> inspect<span style="color:#f92672">.</span>ismethod(obj):
            data[func] <span style="color:#f92672">=</span> obj()
        <span style="color:#66d9ef">else</span>:
            data[func] <span style="color:#f92672">=</span> obj
    <span style="color:#66d9ef">return</span> data</code></pre></div>
<p>You might have performance problems, but if you have a lot of cost to convert an instance, you might be able to run 10 simultaneously using a coroutine, etc. Of course, if the order is important, when you collect the results, there may be a hassle, such as having to rearrange them in order.</p>

      
      <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/post/falcon-rest-template/">Falcon REST API</a></li>
	
</ul>
</div>
      
    </div>
    

    
    <nav class="post-nav">
        
        <a class="prev" href="/post/python_magic_methods/">
            &lt; <span class="prev-text nav-default">[번역] 파이썬 매직 메소드 (Python&#39;s Magic Methods)</span>
                <span class="prev-text nav-mobile"></span>
        </a>
        
        <a class="next" href="/post/effective-go-concurrency/">
            <span class="next-text nav-default">[번역] Effective Go: Concurrency</span>
            <span class="next-text nav-mobile"></span>
            >
        </a>
    </nav>

  </div>
 
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <div id="show_comments"><a id="load_comments" class="button is-link">Load comments</a></div>
  
    <script type="text/javascript">
      var disqus_shortname = 'ziwon';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      
      var hash = window.location.hash.substr(1);
      if ((hash.length > 8) && (hash.substring(0, 8) === "comment-")) {
        disqus();
        document.getElementById("show_comments").style.display = "none";
      } else {
        document.getElementById('load_comments').onclick = function() {
          disqus();
          document.getElementById("show_comments").style.display = "none";
        };
      }
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p><a href="https://github.com/ziwon">Philbert Yoon</a></p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129419926-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

